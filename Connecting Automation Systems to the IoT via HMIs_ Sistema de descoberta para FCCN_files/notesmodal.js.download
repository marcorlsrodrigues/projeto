var ep = window.ep || {}; ep.bundles = ep.bundles || []; ep.bundles = ep.bundles.concat('bundled/notesmodal.js','ep/notedialog.js', 'ep/webservices/common.js', 'ep/webservices/folderwebservice.js');
ep.registerInstance("ep.NoteDialog");ep.NoteDialog=(function(a){var am="invalid_page_selection";var al,k,I,b,v;var L,g,J,F,D,H,G;var W,w,x,C,K,E,f,Y,U,B,y;function s(an){ep.debug("ep/notedialog.js -> _initialize");a(".note-text-area").epeditor();e();Q(an);af();ae();if(ep.Viewer){a("#contextCitation").html(d());a(document).unbind("keydown",ep.Viewer.keyDownHandler);}t();a(window).on("editorIntervalCheck",ep.NoteDialog.onEditorChange);}function n(at,ar,aq,au){ep.debug("ep/notedialog.js -> _getNoteData");var ao={noteID:at,isPostBack:ar,isInViewer:aq,thePostBackElem:au};var ap=o();var an=P;EPWebServices.FolderWebService.FolderReadNote(ap,ao,an,null,null);}function Q(an){ep.debug("ep/notedialog.js -> _parseReadNoteArgs");if(an){if(an.readnote){W=an.readnote;}if(an.noteDoPostBack){C=an.noteDoPostBack;}if(an.notePostBackElem){K=an.notePostBackElem;}if(an.noteIsInViewer){E=an.noteIsInViewer;}if(an.noteID){D=an.noteID;a("#readNoteId").val(D);n(D,C,E,K);}ad();}else{W=false;C=false;if(ep.Viewer){m();}}}function e(){ep.debug("ep/notedialog.js -> _clearGlobalVars");al=k=I=b=v=null;F=D=H=G=Y=K=null;U=B=L=g=J=null;C=E=w=y=W=false;}function af(){ep.debug("ep/notedialog.js -> _setupNoteEmail");if(W&&W==="true"){var an=a("#emailFrame");if(!an){an=a("<iframe>").attr({id:"emailFrame",height:"0",width:"0","class":"hidden"});document.body.appendChild(an[0]);}}}function ae(){ep.debug("ep/notedialog.js -> _setupNoteDialogDisplay");if(W&&W==="true"){ep.debug("ep/notedialog.js -> _setupNoteDialogDisplay -> _readNote!!");a("#editBtn,#deleteBtn,#closeBtn,#notesReadSection").css({display:""});a("#cancelBtn").css({display:"none"});a("#notesEntrySection").css({display:"none"});}else{ep.debug("ep/notedialog.js -> _setupNoteDialogDisplay -> NOT _readNote!!");a("#readTitleSpan,#contentLinkLabel,#notesReadSection,#notesLastEdited").css({display:"none"});a("#createTitleSpan,#saveBtn").css({display:""});}}function ah(aq){ep.debug("ep/notedialog.js -> _stripBadMarkupText");var ao=/<a[^>]+>/;var ap=ao.exec(aq);if(ap!==null){return[aq.substring(0,ap.index),ah(aq.substring(ap.index+ap[0].length))].join("");}else{var an=aq.indexOf("</a>");if(an!==-1){return[aq.substring(0,an),ah(aq.substring(an+4))].join("");}else{return aq;}}}function ad(){ep.debug("ep/notedialog.js -> _setupEditBtnClick");var an=a("#mainModalContent").parent().parent().parent();a("#editBtn").removeAttr("onclick").click(function(){a(an).fadeOut("normal",function(){a("#readTitleSpan,#contentLinkLabel,#editBtn,#closeBtn,#notesReadSection,#showDelivery").css({display:"none",visibility:"hidden"});a("#editTitleSpan,#updateBtn,#cancelBtn").css({display:""});ep.NoteDialog.hidePrintOptions();a(an).fadeIn("normal",t);var ao=a("#noteTextSetup").html();ao=["<div>",ao,"</div>"].join("");a(".note-text-area").val(ao);a("#notesEntrySection").css({display:""});});j(a("#saveBtn"),false);j(a("#updateBtn"),false);});}function A(aq){ep.debug("ep/notedialog.js -> _linkMarkupText");var ap=/[hH][tT][tT][pP][sS]?\:\/\/[^<\s]+/;var an=ap.exec(aq);if(an!==null){var ao=[];ao.push(aq.substring(0,an.index),'<a href="',an);ao.push('" onclick="window.open(this.href); return false;">',an,"</a>");ao.push(A(aq.substring(an.index+an[0].length)));return ao.join("");}else{return aq;}}function t(){ep.debug("ep/notedialog.js -> _initializeDraggable");var an=a("#mainModalContent").parent().parent().parent().parent();an.attr("id","modal_draggable");return a(an).draggable({zIndex:10001,scroll:false,containment:a(document.documentElement)});}function ac(ao,an,au,ap,aq,ar,at){ep.debug("ep/notedialog.js -> _setCurrentCitation");f={database:ao,an:an,uitag:"AN",title:au,doid:ap,plink:aq,pubdate:ar,segid:at};}function d(){ep.debug("ep/notedialog.js -> _buildCitationFromViewerState");if(ep.Viewer&&!al){m();}var ap=al.StateManager.getProperty("twPV")?[al.imageData.label,al.oImageData.label].join(" - "):I.label;var an=[];var ao=k.isMonograph?k.publicationYear:k.publicationDate;var aq=al.articleData?al.articleData.pages:[];if(k.isMonograph){an.push('<p>"',ep.URLDecode(k.title),'"</p><br />');}else{if(al.articleId&&al.articleId!=="NA"){an.push('<p>"',al.articleData.title,'"</p><br />');}}if(!k.isMonograph&&al.articleData&&al.articleData.author&&al.articleData.author!==""){an.push("By: ",ep.URLDecode(al.articleData.author));an.push(ep.URLDecode(al.articleData.author).charAt(ep.URLDecode(al.articleData.author).length-1)!=="."?". ":" ");}else{if(k.isMonograph&&k.authors&&k.authors!==""){an.push("By: ",ep.URLDecode(k.authors));an.push(ep.URLDecode(k.authors).charAt(ep.URLDecode(k.authors).length-1)!=="."?". ":" ");}}if(!k.isMonograph){an.push("<i>",ep.URLDecode(k.title),"</i>, ");}an.push(ao);if(!k.isMonograph){an.push(" ,");if(k.volume!==""){an.push(" Vol. ",k.volume);}if(k.issue!==""){an.push(" Issue ",k.issue);}if(aq.length>1){an.push(", p",k.pageData[_.first(aq)].label,"-",k.pageData[_.last(aq)].label,", ",aq.length,"p;");}else{if(al.articleId&&al.articleId!=="NA"){an.push(", p",I.label);}}}an.push("<br />");if(!k.isMonograph&&al.articleId&&al.articleId!=="NA"&&al.articleData&&al.articleData.an!==null){an.push("(AN ",al.articleData.an,")");}else{if(k.isMonograph){an.push("(AN ",k.an,")");}}an.push("<br /><br />Page  ",ap);return an.join("");}function o(){return{sessionID:document.getElementById("__sid").value,sessionVId:document.getElementById("__vid").value};}function aa(ap){ep.debug("ep/notedialog.js -> _saveNoteFormValidation");var an,ao;an=a(".note-text-area").val();if(an.length<=4000){w=true;ao=an;Z(ap,ao);if(!y){if(false){a("#saveBtn").form.dialog.hide();}else{a("#cancelBtn").click();}}return false;}else{if(y){T();}else{ep.NoteDialog.onEditorChange();}return false;}}function Z(aw,az){ep.debug("ep/notedialog.js -> _saveNote");var at,au,av,ap;az=A(ah(az));if(ep.Viewer){if(k.isMonograph){at=k.tag;au=k.an;av=k.title;}else{if(al.articleData){at=al.articleData.tag;au=al.articleData.an;av=al.articleData.title;}else{at=k.tag;au=k.an;av=k.title;}}var aq=I.label,ay=al.imageData.id;if(al.oImageData){aq=[al.imageData.label,al.oImageData.label].join(" - ");ay=al.oImageData.id;}ap={database:k.db,an:au,uitag:"AN",title:av,doid:k.id,notecontent:az,pageid:I.id,imageid:I.imageId,plink:k.pLink,pubdate:k.isMonograph?k.publicationYear:k.publicationDate,pageLabel:aq,istwopage:al.oImageData?true:false,segid:k.isMonograph?null:al.articleId};if(v){b.noteText=a(".note-text-area").val();b.isInNotes=true;}else{I.noteText=a(".note-text-area").val();I.isInNotes=true;}}else{f.notecontent=az;ap=f;v=true;}var ar=U!==null?U:o();var ao={IsAdd:true,IsEdit:false};var ax=ep.Viewer?true:false;var an=y?R:O;ep.debug("_saveNote(): calling web service...");ep.debug("	aParams = "+JSON.stringify(ar));ep.debug("	aContentItem = "+JSON.stringify(ap));ep.debug("	isRefreshHtml = "+JSON.stringify(aw));ep.debug("	_isArticleNote = "+JSON.stringify(v));ep.debug("	isUpdateInViewer = "+JSON.stringify(ax));ep.debug("	aCallBackMethod = "+JSON.stringify(y?"_popupClose":"_onNoteAddRemove"));ep.debug("	aCallbackParams = "+JSON.stringify(ao));EPWebServices.FolderWebService.FolderPageNoteAdd(ar,ap,aw,v,ax,an,null,ao);}function h(aq){ep.debug("ep/notedialog.js -> _deleteNote");w=true;var ao={noteID:D?D:null};var ap=o();var an={IsAdd:false,IsEdit:false};var at=ep.Viewer?true:false;var ar=C===true?false:aq;EPWebServices.FolderWebService.FolderPageNoteDelete(ap,ao,ar,at,O,null,an);if(C===false){if(false){a("#deleteBtn").form.dialog.hide();}else{a("#cancelBtn").click();}}}function aj(ap){ep.debug("ep/notedialog.js -> _updateNoteFormValidation");var an,ao;an=a(".note-text-area").val();if(an.length<=4000){w=true;ao=an;ai(ap,ao);if(C===false){if(false){a("#updateBtn").form.dialog.hide();}else{a("#cancelBtn").click();}}return false;}else{ep.NoteDialog.onEditorChange();return false;}}function ai(aq,au){ep.debug("ep/notedialog.js -> _updateNote");au=ah(au);au=A(au);var ao={notecontent:au,noteID:D?D:null};var ap=o();var an={IsAdd:false,IsEdit:true};var at=ep.Viewer?true:false;var ar=C===true?false:aq;EPWebServices.FolderWebService.FolderPageNoteUpdate(ap,ao,ar,at,O,null,an);}function q(){ep.debug("ep/notedialog.js -> _hideAndPostBack");if(false){a("#updateBtn").form.dialog.hide();}else{a("#updateBtn").closest("form").hide();a(".modal-dialog .ui-icon-closethick").click();}a("#doPostBackBtn").click();}function z(){return C===true&&w===true?true:false;}function O(ap,ao){ep.debug("ep/notedialog.js -> _onNoteAddRemove");if(C===true){q();}else{if(ap){a("#folderItemsContainerControl").html(ap);}if(ao.IsEdit){if(ep.folder.updateToolbarFolderControl){ep.folder.updateToolbarFolderControl();}}else{if(ep.controller.control.FolderItemsControl){ep.controller.control.FolderItemsControl.updateFolderCount(ao.IsAdd);}else{if(ep.folder.updateToolbarFolderCount){ep.folder.updateToolbarFolderCount(ao.IsAdd);}}}if(ep.Viewer){ep.debug("ep.NoteDialog._onNoteAddRemove(): firing NoteDialog:ItemAddRemove");ep.publish("NoteDialog:ItemAddRemove",ao.IsAdd);}else{var an=a(".addNote");a(an).each(function(ar,aq){if(ao.IsAdd===true||a("#folderNotesGoTo").length){a(aq).addClass("hasNotes");}else{a(aq).removeClass("hasNotes");}});}}}function P(aq,ap){ep.debug("ep/notedialog.js -> _onNoteRead");var ao=a.parseJSON(aq);var an=a("#contextCitation");if(an.html()===""){an.html(ao.NoteContext);}L=ao.NoteText;F=ao.NoteLink;g=ao.DateModified;if(L){a("#noteTextSetup").html(ep.URLDecode(L));a("#notesTextDisplay").html(ep.URLDecode(L));}if(F){a("#contextLink").attr("href",F);}if(ao.isEbook&&ao.ebookJson){a("#contextLink").attr("data-ebook",ao.ebookJson);a("#contextLink").attr("class","ebook-ft");}if(g){a("#notesLastEdited").html(["Last edited:",g].join(" "));}t();}function m(){ep.debug("ep/notedialog.js -> _getDataFromViewer");al=ep.Viewer;k=al.DataManager.data;if(al.imageData){if(!al.imageData.isDummy&&al.imageData.type!=="DUMMY"){I=al.imageData;}else{I=al.oImageData;}}else{if(al.oImageData){I=al.oImageData;}}if(al.articleId===null||al.articleId==="NA"||k.isMonograph){v=false;b={isInNotes:false,noteText:""};}else{v=true;b=k.contents[al.articleId];}}a.fn.cleanWhitespace=function(){textNodes=this.contents().filter(function(){return(this.nodeType===3&&!/\S/.test(this.nodeValue));}).remove();return this;};function ag(){ep.debug("ep/notedialog.js -> _showPrintOptions");a(".notes-modal-dialog").first().width("715px");var an=a("#printEmailOptions").cleanWhitespace();a(an).css("display","");a("#showDelivery").css("display","none");a("#hideDelivery").css("display","");N();t();}function r(){ep.debug("ep/notedialog.js -> _hidePrintOptions");a(".notes-modal-dialog").first().width("415px");var an=a("#printEmailOptions").cleanWhitespace();a(an).css("display","none");a("#showDelivery").css("display","");a("#hideDelivery").css("display","none");t();}function V(){C=true;w=true;}function l(){ep.debug("ep/notedialog.js -> _emailNote");if(ak()){C=false;w=false;if(D){var an={citationFormat:a("#citationFormatSelect").val(),to:a("#emailTo").val(),from:a("#emailFrom").val(),subject:a("#emailSubject").val(),noteId:D};ab(an);if(false){a("#emailBtn").form.dialog.hide();}else{a("#emailBtn").closest("form")[0].hide();a(".modal-dialog .ui-icon-closethick").click();}return false;}}else{return false;}}function ab(ar){ep.debug("ep/notedialog.js -> _sendNoteEmail");var aq="emailnote"+ep.NoteDialog.rootQuery;var ap=a("#emailFrame");if(ap&&ap.length){var an=ap.contentDocument;if(!an&&ap.contentWindow){an=ap.contentWindow.document;}an.open("text/html",true);an.writeln("<html><body>");an.writeln('<form id="emailForm" method="post"><textarea name="data"></textarea></form>');an.writeln("</body></html>");an.close();var ao=an.getElementById("emailForm");ao.action=aq;ao.elements[0].value=JSON.stringify(ar);ao.submit();}}function ak(){ep.debug("ep/notedialog.js -> _validEmailCheck");var an=a("#emailTo").val();var av=a("#emailFrom");var au=a(av).val();var aw=a(av).attr("disabled");var at=a("#invalidEmailPlaceholder").html();var ar=a("#invalidEmailWarning");var ao=a("#emailBtn");var ap=null;var aq=/^([\w-\.]+)@([a-zA-Z0-9_\-]+\.)+[a-zA-Z0-9_\-\.]+/;ap=aq.exec(an);if(ap===null||ap[0]!==an){a(ar).html(an+at);a(ar).css("display","");j(ao,true);return false;}if(aw){return true;}ap=aq.exec(au);if(ap===null||ap[0]!==au){a(ErrorSpan).html(au+at);a(ar).css("display","");j(ao,true);return false;}return true;}function u(an){switch(an){case"<br />":return true;case"<p />":return true;case"<div />":return true;case"<div><div /></div>":return true;case"<div><div><div /></div></div>":return true;case"<div><div><br /></div></div>":return true;case"<div><br /></div>":return true;case"<div><p /></div>":return true;case'<br _moz_editor_bogus_node="TRUE" />':return true;}if(an.length<=0){return true;}else{if(an.length>=4000){return true;}else{return false;}}}function S(aq,an,ao,ap){ep.debug("ep/notedialog.js -> _popupNoteSetup");y=true;Y=a("#"+aq);U={sessionID:ao,sessionVId:ap};B=a("#"+an);}function T(){ep.debug("ep/notedialog.js -> _popupOnEditorChange");var an=a(".note-text-area").val();if(an.length>4000){B.css("display","");}else{B.css("display","none");}j(Y,u(an));}function M(){ep.debug("ep/notedialog.js -> _onEditorChange");if(a(".note-text-area").length){var an=a(".note-text-area").val();if(an.length>4000){a("#maxLengthWarning").css("display","");}else{a("#maxLengthWarning").css("display","none");}var ao=u(an);j(a("#saveBtn"),ao);j(a("#updateBtn"),ao);}}function j(ao,an){if(an){a(ao).attr("disabled",true);a(ao).addClass("notes-footer-disabled");a(ao).removeClass("primary-action");}else{a(ao).attr("disabled",false);a(ao).removeClass("notes-footer-disabled");a(ao).addClass("primary-action");}}function c(ao){var an=ao.keyCode?ao.keyCode:ao.which;if(an===13){ao.returnValue=false;ao.cancel=true;if(ao.stopPropagation){ao.stopPropagation();}}}function N(){ep.debug("ep/notedialog.js -> _onEmailChange");var an=a("#emailBtn");if(a("#emailTo").val()!==""&&a("#emailFrom").val()!==""){j(an,false);a("#invalidEmailWarning").css({display:"none"});}else{j(an,true);}}function X(at,au,ap,aq,ar){ep.debug("ep/notedialog.js -> _readNoteSetup");var ao={readnote:"true",noteID:at,noteIsInViewer:aq,noteDoPostBack:ap,notePostBackElem:au};var an=new ep.dialog.ModalDialog(ar,{command:"createnote",onRender:function(){ep.NoteDialog.initialize(ao);},onHide:ep.NoteDialog.hide,onSubmit:ep.addModalRedirectParameter,titleElement:"#modalDialog%20.header",cssClass:"notes-modal-dialog",screenOpacity:"0.4",onClientAfterHide:ep.NoteDialog.destroyWidget});an.show();}function p(){ep.debug("ep/notedialog.js -> _hide");if(ep.Viewer){a(document).on("keydown",ep.Viewer.keyDownHandler);}a(window).off("editorIntervalCheck",ep.NoteDialog.onEditorChange);}function i(){ep.debug("ep/notedialog.js -> _destroyWidget");a(".note-text-area").epeditor("destroy");}function R(){ep.debug("ep.NoteDialog._popupClose()!");window.close();}return{initialize:function(an){s(an);},saveNote:function(an){aa(an);},updateNote:function(an){aj(an);},deleteNote:function(an){h(an);},hide:function(){p();},destroyWidget:function(){i();},onEditorChange:function(){M();},isPostBack:function(){return z();},showPrintOptions:function(){ag();},hidePrintOptions:function(){r();},setCurrentCitation:function(ao,an,au,ap,aq,ar,at){ac(ao,an,au,ap,aq,ar,at);},popupNoteSetup:function(aq,an,ao,ap){S(aq,an,ao,ap);},popupOnEditorChange:function(){T();},printNote:function(){V();},emailNote:function(){return l();},onEmailChange:function(){N();},blockTitleSubmit:function(an){c(an);},popupClose:function(){R();},readNote:function(aq,ar,ao,an,ap){X(aq,ar,ao,an,ap);}};})(jQuery);(function(a){if(window.EPWebServices===undefined){window.EPWebServices={};}EPWebServices.buildURL=function(e,d){e=e.replace(/^\//,"");d=d.replace(/^\//,"");var c=(this._getHid()!==null)?"?hid="+this._getHid():"";var b=location.href.split("/"+ep.interfaceId+"/")[0]+"/"+e+"/"+d+c;return b;};EPWebServices.doWebServiceCall=function(g,f,d,c,e){ep.debug("ep/webservices/common.js -> doWebServiceCall");var b=a.ajax(g,{type:"POST",contentType:"application/json",data:JSON.stringify(f),dataType:"text",success:function(m,l,j){var h;var i=j.getResponseHeader("content-type")||"";if(i.indexOf("json")>-1){var k=a.parseJSON(m);if(k!==null){h=k.d;}}else{h=m;}if(d){d(h,e);}},error:function(i,j,h){ep.debug("ajax error : "+h);if(c){c(transport.responseText,e);}}});};EPWebServices._getHid=function(){var b=window.location.toString().match(/hid=(\d+)/);if(b!==null&&b.length>1){return b[1];}else{return null;}};})(jQuery);EPWebServices.FolderWebService={};EPWebServices.FolderWebService._SERVICE_URL="/Legacy/Views/WebServices/FolderWebService.asmx";EPWebServices.FolderWebService.FolderPageAddRemove=function(i,f,g,h,d,c,e){var b=EPWebServices.buildURL(this._SERVICE_URL,"FolderPageAddRemove");var a={theSessionParams:i,theContentItem:f,theIsAdd:g,theIsRefreshFolderItems:h};EPWebServices.doWebServiceCall(b,a,d,c,e);};EPWebServices.FolderWebService.FolderItemsAddRemove=function(i,f,g,h,d,c,e){var b=EPWebServices.buildURL(this._SERVICE_URL,"FolderItemsAddRemove");var a={theSessionParams:i,theContentItem:f,theIsAdd:g,theIsRefreshFolderItems:h};EPWebServices.doWebServiceCall(b,a,d,c,e);};EPWebServices.FolderWebService.DAFolderItemsAddRemove=function(i,f,g,h,d,c,e){var b=EPWebServices.buildURL(this._SERVICE_URL,"DAFolderItemsAddRemove");var a={theSessionParams:i,theContentItem:f,theIsAdd:g,theIsRefreshFolderItems:h};EPWebServices.doWebServiceCall(b,a,d,c,e);};EPWebServices.FolderWebService.AddExternalFolderItems=function(f,d,c,e){var b=EPWebServices.buildURL(this._SERVICE_URL,"AddExternalFolderItems");var a={theContentItems:f};EPWebServices.doWebServiceCall(b,a,d,c,e);};EPWebServices.FolderWebService.RemoveExternalFolderItem=function(f,d,c,e){var b=EPWebServices.buildURL(this._SERVICE_URL,"RemoveExternalFolderItem");var a={theContentItems:f};EPWebServices.doWebServiceCall(b,a,d,c,e);};EPWebServices.FolderWebService.FolderItemsRefresh=function(j,h,g,i){var b=EPWebServices.buildURL(this._SERVICE_URL,"FolderItemsRefresh");var a={theSessionParams:j};var d=window.panelLoadState||{};if(d.right){ep.showPanel("rightCollapsible","PanelContainer");}else{var c=getElementById("rightCollapsiblePostBack");if(c){var e=/javascript:\s*__doPostBack\s*\(\s*'([^']+)/;var f=e.exec(c.href);if(f){__doPostBack(f[1],"");}}}EPWebServices.doWebServiceCall(b,a,h,g,i);};EPWebServices.FolderWebService.FolderReadNote=function(g,f,d,c,e){var b=EPWebServices.buildURL(this._SERVICE_URL,"FolderReadNote");var a={theSessionParams:g,theContentItem:f};EPWebServices.doWebServiceCall(b,a,d,c,e);};EPWebServices.FolderWebService.FolderPageNoteAdd=function(j,f,i,g,h,d,c,e){var b=EPWebServices.buildURL(this._SERVICE_URL,"FolderPageNoteAdd");var a={theSessionParams:j,theContentItem:f,theIsRefreshFolderItems:i,theIsArticleNote:g,theIsInViewer:h};EPWebServices.doWebServiceCall(b,a,d,c,e);};EPWebServices.FolderWebService.FolderPageNoteDelete=function(i,f,h,g,d,c,e){var b=EPWebServices.buildURL(this._SERVICE_URL,"FolderPageNoteDelete");var a={theSessionParams:i,theContentItem:f,theIsRefreshFolderItems:h,theIsInViewer:g};EPWebServices.doWebServiceCall(b,a,d,c,e);};EPWebServices.FolderWebService.FolderPageNoteUpdate=function(i,f,h,g,d,c,e){var b=EPWebServices.buildURL(this._SERVICE_URL,"FolderPageNoteUpdate");var a={theSessionParams:i,theContentItem:f,theIsRefreshFolderItems:h,theIsInViewer:g};EPWebServices.doWebServiceCall(b,a,d,c,e);};