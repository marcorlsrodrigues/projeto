ep.registerInstance("ep.controller.control.BookRelatedInformationController","ep.base.Controller",(function(a){function e(n){var m=a(n);var l=a(document.createElement("div")).css({height:"50px"}).addClass("loading");var k=document.location.pathname;k=k.substring(0,k.indexOf("/"+ep.interfaceId));k+="/"+ep.interfaceId+"/catalogitem/getbookrelationshipinfo/";k+="?id="+escape(m.attr("data-related-info-uid"));k+="&sid="+a("#__sid").val()+"&vid="+a("#__vid").val();m.before(l).remove();j({url:k,method:"get",dataType:"html",success:function(o){l.css({height:"auto"}).removeClass("loading").html(o);},error:function(){l.removeClass("loading").html(ep.messages.ajax_error);}});}var g={head:null,waiting:[]};function c(){if(!g.waiting.length){g.head=null;return;}g.head=g.waiting.shift();a.ajax(g.head);}function j(k){k.originalComplete=k.complete;k.complete=(function(l){return function(n,m){c();if(l.originalComplete){l.originalComplete(n,m);}};})(k);g.waiting.push(k);if(!g.head){c();}}function d(){if(a(".custom-widget.running").length===0){a(".widget-loading").hide();}}function i(){if(a(".custom-widget.running").length>0){a(".widget-loading").show();}}function b(m){var k=a(".collapse-content",m.data);k.css({visibility:"hidden"});var l=k[0].style.height;if(!l&&m.seenExpansion){k.carousel();k.css({visibility:"visible"});a(m.target).unbind("click",b);return;}else{m.seenExpansion=true;}window.setTimeout(function(){b(m);},50);}function h(k,l){if(!l){return;}j({url:l,method:"get",dataType:"html",success:(function(m){return function(s){a(m).removeClass("running");if(!s){a(m).addClass("no-results");a(m).find(".collapse-toggle").data("disableexpandcollapse","true");}else{a('#relatedInfoLinks li[data-key="'+a(m).attr("data-key")+'"]').removeClass("display-none");}if(a(".custom-widget.running").length===0){var o=a("#relatedInfoLinks");o.hide().removeClass("hidden");if(a("li:not(.display-none)",o).length!==0){o.fadeIn();}else{o.fadeOut();}}d();if(!s){return;}var n=a(".collapse-content",m)[0];a(n).html(s);var q=parseInt(a(m).find(".widget_min_display_criteria").val(),10);if(a(m).find(".widget_item_count").length>0){var p=parseInt(a(m).find(".widget_item_count").val(),10);if(p>0&&p>=q){a(m).show();}else{a('#relatedInfoLinks li[data-key="'+a(m).attr("data-key")+'"]').hide();}}else{a(m).show();}if(a(".carousel",n).length){ep.require("_layout"+ep.cssLayout+"/bookcarousel.css");ep.require("_layout"+ep.cssLayout+"/carousel.css");ep.require("ep/controller/control/carousel.js");a(".custom-widget-header",m).bind("click",m,b);}if(a(".catalogItemList",n)){a(n).css({textAlign:"left"});a(".preview-hover",n).each(function(){ep.dialog.RecordPreview.addSelfContainedRecordPreview(this,570);});}var r=a("a.restricted",n);if(r.length&&ep.controller.GuestLoginController){ep.controller.GuestLoginController.addRestrictions(r);}};})(k),error:(function(m){return function(){a(m).removeClass("running");a(".collapse-content",m).html(ep.messages.ajax_error);d();};})(k)});}var f={onDomLoad:function(){var k=a(".bookRelatedInformationPlaceHolder");if(k.length){e(k[0]);}i();a(".custom-widget.running").each(function(){h(this,a(".ajax_url",this).val());});a("#content").delegate(".close","click",function(l){a(l.target).closest(".custom-widget").hide();});}};return f;})(jQuery));