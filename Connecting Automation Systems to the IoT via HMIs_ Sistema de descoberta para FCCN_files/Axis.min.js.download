var viz=viz||{};viz.Axis=function(i,t){if(this.vp=i,this._dataset=i._ds,this._variable=t,this._variable_name=this._dataset.columnName(t),this._variable_type=this._dataset.columnType(t),this._is_variable_categorical=this._dataset.isCategorical(this._variable),this._min=this._dataset.min(t),this._max=this._dataset.max(t),this._range=this._max-this._min,this._scale="lin",this._ticks=null,this._ticks_values=[],this._ticks_labels=[],this._ticks_values_index={},this._ticks_posicion=[],this._is_variable_categorical){this._ticks_values=this.vp.getTicks(t),this._ticks=this._ticks_values.length;for(var s=0;s<this._ticks_values.length;s++)this._ticks_values_index[this._ticks_values[s]]=s}this._length=400,this._orientation="horizontal",this._orientation_reversed=!1,this._reversed=!1,this._axis_color="rgb(200,200,200)",this._ticks_color="rgb(200,200,200)",this._grid_lines_color="rgb(200,200,200)",this._division_color="rgb(220,220,220)",this._labels_color="rgb(70,70,70)",this._legend_color="rgb(70,70,70)",this._legend_label="",this._show_line=!0,this._show_ticks=!0,this._show_labels=!0,this._ticks_format="inner",this._is_variable_categorical&&0==this._dataset.isDateType(this._variable)&&(this._ticks_format="outer"),this._show_legend=!0,this._show_only_ticks_end_labels=!1,this._cut_min=!1,this._label_size=14,this._legend_size=14,this._low_padding=20,this._high_padding=20,this._show_grid_lines=!1,this._grid_lines_type="2,2",this._forcelimits=!1,this._grape=(new Grape).enableEvents(!1),this._min_posicion=0,this._max_posicion=this._length},viz.Axis.fn=viz.Axis.prototype,viz.Axis.fn.reversed=function(i){return 0==i?this._reversed=!1:this._reversed=!0,this},viz.Axis.fn.show_ticks=function(i){return 0==i?this._show_ticks=!1:this._show_ticks=!0,this},viz.Axis.fn.scale=function(i){return("lin"==i||"log2"==i||"log10"==i)&&(this._scale=i),this._min<0&&"lin"!=i&&(this._scale="lin"),this},viz.Axis.fn.lin=function(){return this.scale("lin")},viz.Axis.fn.log2=function(){return this.scale("log2")},viz.Axis.fn.log10=function(){return this.scale("log10")},viz.Axis.fn.orientation=function(i){return("horizontal"==i||"vertical"==i)&&(this._orientation=i),this},viz.Axis.fn.ticks_format=function(i){return("inner"==i||"outer"==i)&&(this._ticks_format=i),this},viz.Axis.fn.min=function(i){return"number"!=typeof i?this._min:(i<this._min&&(this._min=i),this._range=this._max-this._min,this._min<0&&"lin"!=this._scale&&(this._scale="lin"),this)},viz.Axis.fn.max=function(i){return"number"!=typeof i?this._max:(i>this._min&&(this._max=i),this._range=this._max-this._min,this)},viz.Axis.fn.ticks=function(i){0==this._is_variable_categorical&&i>=2&&(this._ticks=i)},viz.Axis.fn.applySettings=function(i){"string"==typeof i.scale&&this.scale(i.scale),"undefined"!=typeof i.barmin&&this.min(i.barmin),"undefined"!=typeof i.barmax&&this.max(i.barmax),"undefined"!=typeof i.min&&(this.min(i.min),this._forcelimits=!0),"undefined"!=typeof i.max&&(this.max(i.max),this._forcelimits=!0),"number"==typeof i.padding&&(this._low_padding=i.padding,this._high_padding=i.padding),"boolean"==typeof i.show_ticks&&(this._show_ticks=i.show_ticks),"boolean"==typeof i.show_title&&(this._show_legend=i.show_title),"boolean"==typeof i.show_labels&&(this._show_labels=i.show_labels),"boolean"==typeof i.show_label&&(this._show_legend=i.show_label),"boolean"==typeof i.show_line&&(this._show_line=i.show_line),"boolean"==typeof i.show_grid_lines&&(this._show_grid_lines=i.show_grid_lines),"string"==typeof i.grid_lines_type&&(this._grid_lines_type=i.grid_lines_type),raceme._getRGB(i.grid_lines_color)!==!1&&(this._grid_lines_color=i.grid_lines_color),"string"==typeof i.label&&(this._legend_label=i.label),"number"==typeof i.labels_size&&(this._label_size=i.labels_size),"number"==typeof i.label_size&&(this._legend_size=i.label_size),"number"==typeof i.ticks&&this.ticks(i.ticks),"boolean"==typeof i.reversed&&(this._reversed=i.reversed),"string"==typeof i.orientation&&("horizontal"==this._orientation?"top"==i.orientation?this._orientation_reversed=!0:"bottom"==i.orientation&&(this._orientation_reversed=!1):"right"==i.orientation?this._orientation_reversed=!0:"left"==i.orientation&&(this._orientation_reversed=!1))},viz.Axis.fn.legend_size=function(i){return this._legend_size=i,this},viz.Axis.fn.length=function(i){return this._length=i,this},viz.Axis.fn.init=function(){return 0==this._is_variable_categorical&&(null==this._ticks&&(this._ticks=parseInt(this._length/70)),0==this._ticks&&(this._ticks=1),"lin"==this._scale?this._numericNiceScale():"log2"==this._scale?this._log2Scale():"log10"==this._scale&&this._log10Scale()),this._format_labels(),""==this._legend_label&&(this._legend_label=this._variable_name),this._length<1.5*(this._low_padding+this._high_padding)&&(this._low_padding=0,this._high_padding=0),this._min_posicion=this._low_padding,this._max_posicion=this._length-this._high_padding,this._generateGrape(),this},viz.Axis.fn._numericNiceScale=function(){if(0==this._range)return this._ticks=3,void(this._ticks_values=["",viz.Utils.round(this._min,2),""]);var i=this._range/this._ticks;if(this._dataset.isInteger(this._variable)&&1>i&&(this._ticks=this._range+1,i=1),this._forcelimits)for(var t=10;viz.Utils.decimals(i)>0&&t>0;)this._ticks++,i=this._range/this._ticks,t--;for(var s=0,e=0;.1>=i;)i*=10,e++;for(;i>=1;)i/=10,s++;for(.1>=i?i=.1*Math.pow(10,s):.2>=i?i=.2*Math.pow(10,s):.25>=i?i=.25*Math.pow(10,s):.3>=i?i=.3*Math.pow(10,s):.4>=i?i=.4*Math.pow(10,s):.5>=i?i=.5*Math.pow(10,s):.6>=i?i=.6*Math.pow(10,s):.7>=i?i=.7*Math.pow(10,s):.75>=i?i=.75*Math.pow(10,s):.8>=i?i=.8*Math.pow(10,s):.9>=i?i=.9*Math.pow(10,s):1>=i&&(i=Math.pow(10,s));e>0;)i/=10,e--;var _=i*parseInt(this._min/i);_>this._min?this._min=i*parseInt(-1+this._min/i):this._min=_;var h=i*parseInt(this._max/i);h<this._max?this._max=i*parseInt(1+this._max/i):this._max=h,this._range=this._max-this._min,this._ticks=this._range/i,this._ticks_values=[];for(var n=this._min,o=this._range/this._ticks,a=0;a<this._ticks+1&&n<this._max+o;a++)(0==this._dataset.isInteger(this._variable)||0==viz.Utils.decimals(n))&&this._ticks_values.push(viz.Utils.round(n,12)),n+=o;this._ticks=this._ticks_values.length},viz.Axis.fn._log2Scale=function(){var i=viz.Utils.log2(Math.max(0,this._min)),t=viz.Utils.log2(Math.max(0,this._max));i=Math.floor(i),t=Math.ceil(t),this._min=Math.min(this._min,Math.pow(2,i)),this._max=Math.pow(2,t);var s=[];for(h=i;t>=h;h++)s.push(h);var e=1;if(s.length-1>this._ticks)for(var _=Math.round(s.length/this._ticks);_>1;){if(0==viz.Utils.fmod(s.length-1,_)){e=_;break}_--}this._ticks_values=[];for(var h=0;h<s.length;h+=e)this._ticks_values.push(Math.pow(2,s[h]));this._ticks=this._ticks_values.length},viz.Axis.fn._log10Scale=function(){var i=viz.Utils.log10(Math.max(0,this._min)),t=viz.Utils.log10(Math.max(0,this._max));i=Math.floor(i),t=Math.ceil(t),this._min=Math.pow(10,i),this._max=Math.pow(10,t);for(var s=[],e=i;t>=e;e++)s.push(e);for(this._ticks_values=[],e=0;e<s.length;e++)this._ticks_values.push(Math.pow(10,s[e]));this._ticks=this._ticks_values.length},viz.Axis.fn._generateGrape=function(){var i,t=0,s=this._grape,e=1;0==this._show_line&&(e=0),s.lineStyle(1,this._axis_color,e),"horizontal"==this._orientation?s.line(0,0,this._length,0):s.line(0,0,0,this._length);var _;if(this._show_ticks||this._show_grid_lines){if(t=5,"inner"==this._ticks_format)for(_=this._max_posicion!=this._min_posicion&&this._ticks>1?(this._max_posicion-this._min_posicion)/(this._ticks-1):0,i=0;i<this._ticks;i++)"string"==typeof this._ticks_labels[i]&&this._ticks_posicion.push(this._min_posicion+i*_);else for(_=this._max_posicion!=this._min_posicion?(this._max_posicion-this._min_posicion)/this._ticks:0,this._ticks_posicion.push(this._min_posicion),i=1;i<this._ticks+1;i++)("string"==typeof this._ticks_labels[i]||i==this._ticks)&&this._ticks_posicion.push(this._min_posicion+i*_);if(this._reversed&&"horizontal"==this._orientation||this._reversed&&"vertical"==this._orientation&&this._is_variable_categorical||0==this._reversed&&"vertical"==this._orientation&&0==this._is_variable_categorical)for(i=0;i<this._ticks_posicion.length;i++)"string"==typeof this._ticks_labels[i]&&(this._ticks_posicion[i]=this._length-this._ticks_posicion[i]);if(this._show_ticks)for(s.lineStyle(1,this._ticks_color),i=0;i<this._ticks_posicion.length;i++)"horizontal"==this._orientation&&0==this._orientation_reversed?s.line(this._ticks_posicion[i],0,this._ticks_posicion[i],5):"horizontal"==this._orientation&&1==this._orientation_reversed?s.line(this._ticks_posicion[i],0,this._ticks_posicion[i],-5):"vertical"==this._orientation&&0==this._orientation_reversed?s.line(0,this._ticks_posicion[i],-5,this._ticks_posicion[i]):"vertical"==this._orientation&&1==this._orientation_reversed&&s.line(0,this._ticks_posicion[i],5,this._ticks_posicion[i])}if(this._show_labels){var h=t+10,n="center",o="middle";"horizontal"==this._orientation&&0==this._orientation_reversed?o="bottom":"horizontal"==this._orientation&&1==this._orientation_reversed?(h=-h,o="top"):"vertical"==this._orientation&&0==this._orientation_reversed?(n="right",h=-h):"vertical"==this._orientation&&1==this._orientation_reversed&&(n="left");var a=new GrapeGroup;_=this._max_posicion!=this._min_posicion&&this._ticks>1?(this._max_posicion-this._min_posicion)/(this._ticks-1):0;var l=this._min_posicion;"outer"==this._ticks_format&&(_=(this._max_posicion-this._min_posicion)/this._ticks,l+=_/2);var r=null;for(i=0;i<this._ticks;i++)if("string"==typeof this._ticks_labels[i]){var c=raceme.label(this._ticks_labels[i],0,0,this._labels_color,this._label_size,n,o);if("horizontal"==this._orientation){c.y(h),c.x(l+i*_);var v=c.getBBox();"inner"==this._ticks_format&&(v.x<0?(c.x(-v.x),v.x=c.x()-v.width/2):v.x+v.width>this._length&&(c.x(this._length-v.width/2),v.x=this._length-v.width)),(null==r||v.x>r)&&(a.push(c),r=v.x+v.width,r+=10,this._reversed&&c.x(this._length-c.x()))}else c.x(h),c.y(l+i*_),"inner"==this._ticks_format&&(c.y()+this._label_size/2>this._length?c.y(c.y()-.5*this._label_size):c.y()-.5*this._label_size<0&&c.y(c.y()+this._label_size/2)),(null==r||c.y()>r)&&(a.push(c),r=c.y()+this._label_size+2,(this._reversed&&this._is_variable_categorical||0==this._reversed&&0==this._is_variable_categorical)&&c.y(this._length-c.y()))}a.addTo(s)}if(this._show_legend){var g=s.getBBox(),d=raceme.label(this._legend_label,0,0,this._legend_color,this._legend_size,"center");d.attr("font-weight","bold"),"horizontal"==this._orientation&&0==this._orientation_reversed?d.x(g.width/2).y(g.height+this._legend_size):"horizontal"==this._orientation&&1==this._orientation_reversed?d.x(g.width/2).y(-g.height-this._legend_size):"vertical"==this._orientation&&0==this._orientation_reversed?(d.x(-g.width-this._legend_size).y(g.height/2),d.rotation(-90)):"vertical"==this._orientation&&1==this._orientation_reversed&&(d.x(g.width+this._legend_size).y(g.height/2),d.rotation(90)),d.addTo(s)}},viz.Axis.fn.getGrape=function(){return this._grape},viz.Axis.fn.x=function(){return this._grape.x()},viz.Axis.fn.innerX=function(){return"horizontal"==this._orientation?this.x()+this._low_padding:this.x()},viz.Axis.fn.y=function(){return this._grape.y()},viz.Axis.fn.innerY=function(){return"vertical"==this._orientation?this.y()+this._low_padding:this.y()},viz.Axis.fn.getGridLines=function(i){var t=new Grape;t.x(i.x).y(i.y).enableEvents(!1),"solid"==this._grid_lines_type?t.lineStyle(1,this._grid_lines_color,1,"butt","miter"):t.lineStyle(1,this._grid_lines_color,1,"butt","miter",4,"2,2");for(var s=0;s<this._ticks_posicion.length;s++)"vertical"==this._orientation?t.line(0,this._ticks_posicion[s],i.width,this._ticks_posicion[s]):t.line(this._ticks_posicion[s],0,this._ticks_posicion[s],i.height);return t},viz.Axis.fn._format_labels=function(){var i;if(0==this._is_variable_categorical)for(i=0;i<this._ticks;i++)this._ticks_values[i]>=1e9&&viz.Utils.decimals(this._ticks_values[i]/1e9)<3?this._ticks_labels[i]=(this._ticks_values[i]/1e9).toString()+"G":this._ticks_values[i]>=1e6&&viz.Utils.decimals(this._ticks_values[i]/1e6)<3?this._ticks_labels[i]=(this._ticks_values[i]/1e6).toString()+"M":this._ticks_values[i]>=1e3&&viz.Utils.decimals(this._ticks_values[i]/1e3)<3?this._ticks_labels[i]=(this._ticks_values[i]/1e3).toString()+"k":1e-6==this._ticks_values[i]&&"log10"==this._scale?this._ticks_labels[i]=String.fromCharCode(8776)+this._ticks_values[i].toString():.125==this._ticks_values[i]&&"log2"==this._scale&&this._min<.125?this._ticks_labels[i]=String.fromCharCode(8776)+this._ticks_values[i].toString():this._ticks_labels[i]=this._ticks_values[i].toString();else if(this._dataset.isDateType(this._variable)){var t=parseFloat(this._length/70);"vertical"==this._orientation&&(t=parseFloat(this._length/this._label_size));var s,e=(this._ticks,"day"),_=this._variable_type;"YYYY"==_?e="year":("MM-YYYY"==_||"YYYY-MM"==_||"MM"==_)&&(e="month");var h=viz.Utils.date(this._ticks_values[0],_),n=viz.Utils.date(this._ticks_values[this._ticks-1],_);"day"==e&&(s=viz.Utils.differenceInDays(h,n),s>t&&"dd"!=_&&(e="month")),"month"==e&&(s=viz.Utils.differenceInMonths(h,n),s>t&&(e="trimester")),"trimester"==e&&(s/=3,s>t&&"dd-MM"!=_&&"MM"!=_&&(e="year")),"year"==e&&(""==_&&(s=n.getFullYear()-h.getFullYear()),s>t&&(e="decade"));var o,a=viz.Utils.date(this._ticks_values[0],_),l=[0,3,6,9];for(i=0;i<this._ticks;i++)"day"==e?"dd"==_?this._ticks_labels[i]=parseInt(this._ticks_values[i]).toString():this._ticks_labels[i]=this._ticks_values[i]:"month"==e?(o=viz.Utils.date(this._ticks_values[i],_),(0==i||o.getMonth()!=a.getMonth())&&(h.getFullYear()==n.getFullYear()?this._ticks_labels[i]=o.strformat("MM",{month:"short"}):this._ticks_labels[i]=o.strformat("MM-YYYY",{month:"short"}),a=new Date(o.valueOf()))):"trimester"==e?(o=viz.Utils.date(this._ticks_values[i],_),(0==i||i==this._ticks-1&&o.getMonth()!=a.getMonth()||o.getMonth()!=a.getMonth()&&-1!=l.indexOf(o.getMonth()))&&(h.getFullYear()==n.getFullYear()?this._ticks_labels[i]=o.strformat("MM",{month:"short"}):this._ticks_labels[i]=o.strformat("MM-YYYY",{month:"short"}),a=new Date(o.valueOf()))):"year"==e?(o=viz.Utils.date(this._ticks_values[i],_),(0==i||o.getFullYear()!=a.getFullYear())&&(this._ticks_labels[i]=o.strformat("YYYY"),a=new Date(o.valueOf()))):"decade"==e&&(o=viz.Utils.date(this._ticks_values[i],_),(0==i||i==this._ticks-1&&o.getFullYear()!=a.getFullYear()||o.getFullYear()!=a.getFullYear()&&0==viz.Utils.decimals(o.getFullYear()/10))&&(this._ticks_labels[i]=o.strformat("YYYY"),a=new Date(o.valueOf())))}else for(i=0;i<this._ticks;i++)this._ticks_labels[i]=this._ticks_values[i]},viz.Axis.fn.getPoint=function(i){var t=0,s=viz.Utils.map;if(0==this._is_variable_categorical)"lin"==this._scale?t=this._min==this._max&&this._min==i?this._min_posicion+(this._max_posicion-this._min_posicion)/2:s(i,this._min,this._max,this._min_posicion,this._max_posicion):"log2"==this._scale?t=s(viz.Utils.log2(i),viz.Utils.log2(this._min),viz.Utils.log2(this._max),this._min_posicion,this._max_posicion):"log10"==this._scale&&(t=s(viz.Utils.log10(i),viz.Utils.log10(this._min),viz.Utils.log10(this._max),this._min_posicion,this._max_posicion));else if(this._is_variable_categorical){var e;if("number"==typeof this._ticks_values_index[i]){e=this._ticks_values_index[i];var _=0;this._max_posicion!=this._min_posicion&&this._ticks>1&&(_=(this._max_posicion-this._min_posicion)/(this._ticks-1));var h=this._min_posicion;"outer"==this._ticks_format&&this._max_posicion!=this._min_posicion&&this._ticks>0&&(_=(this._max_posicion-this._min_posicion)/this._ticks,h+=_/2),t=h+e*_}}return("vertical"==this._orientation&&this._reversed&&this._is_variable_categorical||"vertical"==this._orientation&&0==this._reversed&&0==this._is_variable_categorical||"horizontal"==this._orientation&&this._reversed)&&(t=this._length-t),t},viz.Axis.fn.getSpacePoint=function(){return(this._max_posicion-this._min_posicion)/this._ticks};