var viz=viz||{};
viz.Legend=function(f,m){this.vp=f;this.pr=m;this.variable=this.vp.firstVariable(this.pr);this.variable_type=this.vp._ds.columnType(this.variable);this.gr=(new Grape).enableEvents(!1);this.legend_title=this.vp._ds.columnName(this.variable);"string"==typeof this.vp.getSettings(this.variable,this.pr,"label")&&(this.legend_title=this.vp.getSettings(this.variable,this.pr,"label"));this.label_color="rgb(70,70,70)";this.vp.getSettings(this.variable,this.pr,"label_color")&&(this.label_color=this.vp.getSettings(this.variable,
this.pr,"label_color"));var d=10;""!=this.legend_title&&(this.legend_title=raceme.label(this.legend_title,0,0,this.label_color,14,"left","bottom"),this.legend_title.attr("font-weight","bold"),this.gr.addChild(this.legend_title),d=40);var c,b,a;if(this.pr==viz.HUE)if(this.vp._ds.isDateType(this.variable))for(c=this.vp._ds.min(this.variable),b=this.vp._ds.max(this.variable),"number"===typeof this.vp.min_hue_value&&(c=this.vp.min_hue_value),"number"===typeof this.vp.max_hue_value&&(b=this.vp.max_hue_value),
raceme.label(this._format_number(c),0,d,this.label_color,14,"left","middle").addTo(this.gr),raceme.label(this._format_number(b),21*this.vp.hue_legend_division,d,this.label_color,14,"right","middle").addTo(this.gr),d+=14,a=0;a<this.vp.hue_legend_division;a++){var e;0==a?e=c:a==this.vp.hue_legend_division-1?e=b:(e=viz.Utils.map(a+0.5,0,this.vp.hue_legend_division,viz.Utils.date(c,this.vp._ds.columnType(this.variable)).getTime(),viz.Utils.date(b,this.vp._ds.columnType(this.variable)).getTime()),e=(new Date(e)).strformat(this.vp._ds.columnType(this.variable)));
this.gr.beginFill(this.vp.getColor(e),1).lineStyle(0).rect(21*a,d,19,19)}else if(this.vp._ds.isCategorical(this.variable))for(c=this.vp.getTicks(this.variable),a=0;a<c.length;a++){b=this.vp.default_form;if(b==viz.NONE_SHAPE||b==viz.GEO_SHAPE)b=viz.FILLED_DISK;e=(new Grape).addTo(this.gr);this.vp.getFormGrape(b,150,this.vp.getColor(c[a]),1).x(10).y(d).addTo(e);e._is_legend_element=!0;-1!=this.vp.view._viewidgroup&&this.vp.view.filterWrapper(e,this.variable,this.vp._ds.rows(this.variable,c[a]));raceme.label(c[a],
25,d-2,this.label_color,14,"left","middle").addTo(e);d+=20}else{if("number"===this.variable_type)for(c=this.vp._ds.min(this.variable),b=this.vp._ds.max(this.variable),"number"===typeof this.vp.min_hue_value&&(c=this.vp.min_hue_value),"number"===typeof this.vp.max_hue_value&&(b=this.vp.max_hue_value),raceme.label(this._format_number(c),0,d,this.label_color,14,"left","middle").addTo(this.gr),raceme.label(this._format_number(b),21*this.vp.hue_legend_division,d,this.label_color,14,"right","middle").addTo(this.gr),
d+=14,a=0;a<this.vp.hue_legend_division;a++)e=0==a?c:a==this.vp.hue_legend_division-1?b:viz.Utils.map(a+0.5,0,this.vp.hue_legend_division,c,b),this.gr.beginFill(this.vp.getColor(e),1).lineStyle(0).rect(21*a,d,19,19)}else if(this.pr==viz.AREA&&(this.vp.default_form!=viz.GEO_SHAPE||0<this.vp.countVariables(viz.SHAPE))){c=this.vp._ds.min(this.variable);b=this.vp._ds.max(this.variable);"number"===typeof this.vp.min_area_value&&(c=this.vp.min_area_value);"number"===typeof this.vp.max_area_value&&(b=this.vp.max_area_value);
a=this.vp.getFormGrape(viz.DISK,this.vp.getArea(b),this.vp.default_hue,0.4);e=this.vp.getFormGrape(viz.DISK,this.vp.getArea(0.25*b),this.vp.default_hue,0.4);var h=this.vp.getFormGrape(viz.DISK,this.vp.getArea(0.5*b),this.vp.default_hue,0.4),g=a.getBBox(),k=e.getBBox(),l=h.getBBox();a.x(g.width/2).y(d+g.height/2);d=raceme.label(this._format_number(b),a.x(),a.y()-g.height/2-5,this.label_color,14,"left","top");h.x(a.x()).y(a.y()+g.height/2-l.height/2);var n=raceme.label(this._format_number(0.5*b),a.x(),
h.y()-l.height/2-5,this.label_color,14,"left","top");e.x(a.x()).y(a.y()+g.height/2-k.height/2);var p=raceme.label(this._format_number(0.25*b),a.x(),e.y()-k.height/2-5,this.label_color,14,"left","top");this.gr.addChild(a);this.gr.addChild(d);14<g.height-l.height&&(14<l.height-k.height&&0.5*b>c)&&(this.gr.addChild(h),this.gr.addChild(n));14<g.height-k.height&&0.25*b>c&&(this.gr.addChild(e),this.gr.addChild(p))}};viz.Legend.fn=viz.Legend.prototype;viz.Legend.fn.getGrape=function(){return this.gr};
viz.Legend.fn._format_number=function(f){return 1E9<=f?viz.Utils.round(f/1E9,2).toString()+"G":1E6<=f?viz.Utils.round(f/1E6,2).toString()+"M":1E4<=f?viz.Utils.round(f/1E3,2).toString()+"k":viz.Utils.round(f,2)};
