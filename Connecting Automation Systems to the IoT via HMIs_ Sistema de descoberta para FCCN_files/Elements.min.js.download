var viz=viz||{};viz.Elements=function(e,t){if(this._frame=e,this._properties=this._frame._properties,this._dataset=t||this._properties._ds,this.gr=new Grape,this.linksgroup=new GrapeGroup,this.linksgr=new Grape,this.labelsgroup=new GrapeGroup,this._frame.labelsgroup=this.labelsgroup,this.labelsgr=new Grape,this._frame.labelsgr=this.labelsgr,e._map){var a=(new Grape).x(e._dataspace.x).y(e._dataspace.y);a.addChild(e._map.root),this.gr.addChild(a)}},viz.Elements.fn=viz.Elements.prototype,viz.Elements.fn.init=function(){var e,t,a,i=this,r=new GrapeGroup,o=this._properties,s=this._dataset.sums();if(o.countVariables(viz.CONNECTION)>0&&(this.connectionValues=this._dataset.getTicks(o.firstVariable(viz.CONNECTION))),1==o.countVariables(viz.ANIMATION)&&1==o.countVariables(viz.UNIT)){for(var l=o.firstVariable(viz.ANIMATION),_=o.firstVariable(viz.UNIT),n=this._dataset.split(_),h=this._dataset.getTicks(l),d=0;d<n.length;d++){var e=new Grape("circle"),t=o.getTooltip(n[d].row(0)),m=n[d].row(0);""!=t&&e.addChild(new Grape("title").text(t)),e.addClass("animatable_viz"),e._data_animation=new Array,o.default_border_width>0&&(e.attr("stroke-width",o.default_border_width),o.default_border_intensity<1&&e.attr("stroke-opacity",o.default_border_intensity),o.default_border_color&&e.attr("stroke",o.default_border_color)),o.view.filterWrapper(e,_,m);var f=0,p=!0;e._data_form_vp={form:"animatedcircle",radius:0,x:0,y:0},n[d].eachRow(function(t){var a=t[l],r=h.indexOf(a);if(r>-1){var s=i._frame.getPoints(t),_=s.x,n=s.y,d=raceme._radius(o.getArea(t));f+=d;var m=o.getColor(t),c=o.getIntensity(t);e._data_animation[r]={cx:Math.round(_),cy:Math.round(n),r:Math.round(d),fill:m,"fill-opacity":c},o.default_border_width>0&&(e._data_animation[r]["stroke-width"]=o.default_border_width,o.default_border_intensity<1&&(e._data_animation[r]["stroke-opacity"]=o.default_border_intensity),o.default_border_color&&(e._data_animation[r].stroke=o.default_border_color)),0==r&&(e.attr("cx",_),e.attr("cy",n),e.attr("r",d),e.fill(m),e.attr("fill-opacity",c),e._data_form_vp={form:"animatedcircle",radius:d,x:_,y:n}),p&&(i.addLabel(e,t),p=!1)}}),e.area_size=f,e._data_animation=viz.Utils.objInterpolation(e._data_animation,["cx","cy","r","fill","fill-opacity"]),r.push(e)}o.countVariables(viz.AREA)>0&&this.sortElements(r),r.addTo(this.gr)}else if(o.countVariables(viz.DIVISION)>0&&1==o.countVariables(viz.ANGLE))if(0==o.countVariables(viz.UNIT)){var c;c="top"==this._frame._chart_vertical_align?this.drawPie(this._dataset,this._frame._dataspace.x+this._frame._dataspace.width/2,this._frame._dataspace.y+Math.min(this._frame._dataspace.width/2,this._frame._dataspace.height/2),Math.min(this._frame._dataspace.width/2,this._frame._dataspace.height/2)):this.drawPie(this._dataset,this._frame._dataspace.x+this._frame._dataspace.width/2,this._frame._dataspace.y+this._frame._dataspace.height/2,Math.min(this._frame._dataspace.width/2,this._frame._dataspace.height/2)),this.gr.addChild(c),c.scale(.2).opacity(0).animate(200).ease("out").scale(1).opacity(1)}else{for(var v=this._dataset.split(o.firstVariable(viz.UNIT)),g=0;g<v.length;g++){var u=v[g].sums(),b=this._frame.getPoints(u),x=raceme._radius(o.getArea(u)),y=this.drawPie(v[g],b.x,b.y,x);r.push(y)}o.countVariables(viz.AREA)>0&&this.sortElements(r),r.addTo(this.gr),r.scale(.2).opacity(0).animate(200).ease("out").scale(1).opacity(1)}else o.default_form==viz.GEO_SHAPE&&0==o.countVariables(viz.SHAPE)&&this._frame._map?this._dataset.eachRow(function(e,t){i.drawBackgroundElement(e,s)}):(0==o.countVariables(viz.AREA)&&(o.countVariables(viz.HUE)>0&&0==o.isSet(o.firstVariable(viz.HUE),viz.POS_X)&&0==o.isSet(o.firstVariable(viz.HUE),viz.POS_Y)?a=o.firstVariable(viz.HUE):o.countVariables(viz.SHAPE)>0&&0==o.isSet(o.firstVariable(viz.SHAPE),viz.POS_X)&&0==o.isSet(o.firstVariable(viz.SHAPE),viz.POS_Y)&&(a=o.firstVariable(viz.SHAPE))),o.eachRowOrdered(function(e,t){r.push(i.drawElement(e,s))},a),o.countVariables(viz.AREA)>0&&this.sortElements(r),r.addTo(this.gr));if("graph"==this._frame._frame_type&&this.drawGraphLinks(),this.labelsgroup._check_overlapping=function(){var e,t,a=[];if(0==i._frame._allow_label_overlapping){for(var r=0;r<this.length;r++)if(t=this.item(r),"animatedcircle"==t._elmviz._data_form_vp.form&&0==t._elmviz._data_form_vp.radius)a[r]=0;else{a[r]=1,t._tmpbbox=t.getBBox();for(var o=0;o<this.length;o++){if(e=this.item(o),r>o&&a[o]>0&&viz.Utils.intersectRect(t._tmpbbox,e._tmpbbox)){a[r]=0;break}if(o!=r&&"slice"!=e._elmviz._data_form_vp.form){var s=e._elmviz.scale();if("bar"==e._elmviz._data_form_vp.form){var l,_,l={x:e._elmviz.x()-e._elmviz._data_form_vp.width/2,y:e._elmviz.y()-e._elmviz._data_form_vp.height/2,width:e._elmviz._data_form_vp.width,height:e._elmviz._data_form_vp.height};if(_=t._tmpbbox,viz.Utils.intersectRect(l,_)){a[r]=0;break}}else{var n,h;"animatedcircle"==e._elmviz._data_form_vp.form?(n={x:e._elmviz._data_form_vp.x,y:e._elmviz._data_form_vp.y,radius:e._elmviz._data_form_vp.radius+5},h=t._tmpbbox):(n={x:e._elmviz.x()/s,y:e._elmviz.y()/s,radius:e._elmviz._data_form_vp.radius},h={x:t.x()/s-t._tmpbbox.width/2,y:t.y()/s-t._tmpbbox.height/2,width:t._tmpbbox.width,height:t._tmpbbox.height}),viz.Utils.intersectRectCircle(h,n)&&(a[r]=0)}}}}for(r=0;r<this.length;r++)this.item(r).opacity(a[r])}},this.labelsgroup._automatic_placement=function(){var e,t,a,r,o,s,l,_=!1,t=i.gr.scale(),n=i._frame._label_placement;if("automatic"==n&&this.length>0&&"slice"==this.item(0)._elmviz._data_form_vp.form&&(n="out"),"automatic"==n&&this.length>0&&"bar"==this.item(0)._elmviz._data_form_vp.form&&(n="in"),"in"==n)for(e=0;e<this.length;e++)o=this.item(e),s=o._elmviz._data_form_vp,"slice"==s.form?(a=s.parent.x()+s.xin/t,r=s.parent.y()+s.yin/t):"animatedcircle"==s.form||"country"==s.form?(a=s.x,r=s.y):"bar"==s.form?(o._tmpbox=o._tmpbox||o.getBBox(),"horizontal"==s.orientation?(a=o._elmviz.x()-s.width/2+o._tmpbox.width/2+2,o._tmpbox.width+2>s.width&&s.width+o._tmpbox.width+2<i._frame._dataspace.width&&(a=o._elmviz.x()+s.width/2+o._tmpbox.width/2+3),r=o._elmviz.y()):(a=o._elmviz.x(),r=o._elmviz.y()+s.height/2-o._tmpbox.height/2)):(a=o._elmviz.x(),r=o._elmviz.y()),o.x(a),o.y(r);else if("out"==n)for(e=0;e<this.length;e++)o=this.item(e),s=o._elmviz._data_form_vp,"slice"==s.form?(_=!0,a=s.parent.x()+s.xout/t,r=s.parent.y()+s.yout/t):"animatedcircle"==s.form||"country"==s.form?(a=s.x,r=s.y):"bar"==s.form?(o._tmpbox=o._tmpbox||o.getBBox(),"horizontal"==s.orientation?(a=o._elmviz.x()+s.width/2+o._tmpbox.width/2+3,s.width+6+o._tmpbox.width>i._frame._dataspace.width&&o._tmpbox.width+6<s.width&&(a-=o._tmpbox.width+6),r=o._elmviz.y()):(a=o._elmviz.x(),r=o._elmviz.y()-s.height/2-o._tmpbox.height/2)):(a=o._elmviz.x(),r=o._elmviz.y()),o.x(a),o._tmpbox=o._tmpbox||o.getBBox(),"slice"==s.form||"country"==s.form||"bar"==s.form?o.y(r):o.y(r-o._tmpbox.height/2/t-s.radius/t);else if("automatic"==n){for(_=!0,l=new Array,e=0;e<this.length;e++){o=this.item(e),s=o._elmviz._data_form_vp;var h={};"country"==s.form||"animatedcircle"==s.form?(h.circle_x=s.x*t,h.circle_y=s.y*t):(h.circle_x=o._elmviz.x()*t,h.circle_y=o._elmviz.y()*t),h.circle_r=s.radius,l.push(h)}l=viz.Utils.labelPlacement(l,i._frame._dataspace.width*t,i._frame._dataspace.height*t)}if(_)for(e=0;e<this.length;e++){o=this.item(e),s=o._elmviz._data_form_vp;var d,m=s.form;"automatic"==n?(o.x(l[e].x/t),o.y(l[e].y/t),d=l[e].angle):d=s.angle,o._tmpbox=o._tmpbox||o.getBBox();var f;d>280||80>d?o.x(o.x()+o._tmpbox.width/t/2+2/t):260>d&&d>100?o.x(o.x()-o._tmpbox.width/t/2-2/t):d>=260&&280>=d?(f=raceme.map(d,260,280,0,o._tmpbox.width/t),o.x(o.x()-o._tmpbox.width/t/2+f)):d>=80&&100>=d&&(f=raceme.map(d,80,100,o._tmpbox.width/t,0),o.x(o.x()-o._tmpbox.width/t/2+f)),"country"!=m&&(d>10&&170>d?o.y(o.y()+o._tmpbox.height/t/2):d>180&&350>d&&o.y(o.y()-o._tmpbox.height/t/2))}},this.labelsgroup.length>0&&(this.labelsgr.addClass("forceredrawelement"),this.labelsgr._force_redraw=function(){i.labelsgr.opacity(1),i.labelsgroup._automatic_placement(),i.labelsgroup._check_overlapping()},this.labelsgroup.addTo(this.labelsgr),this._frame._map?this.labelsgr.opacity(0):(this.labelsgroup._automatic_placement(),this.labelsgroup._check_overlapping()),this.labelsgr.addTo(this.gr)),this.connectionReferences){var z,w=new Grape,E=new Grape;for(z in this.connectionReferences){var C=this.getConnectionGrape(this.connectionReferences[z]);w.addChild(C[0]),E.addChild(C[1])}w.addTo(this.gr).toBack(),E.addTo(this.gr).toBack()}this._frame.zoomable&&(this._frame._map||"graph"==this._frame._frame_type)&&this.gr.zoomable(this._frame._dataspace.x,this._frame._dataspace.y,this._frame._dataspace.width,this._frame._dataspace.height,14),"graph"==this._frame._frame_type&&this._frame.doGraphLayout(this.linksgroup,this.labelsgroup)},viz.Elements.fn.sortElements=function(e){e.sort(function(e,t){var a=e.area_size,i=t.area_size;return i>a?1:a>i?-1:0})},viz.Elements.fn.drawElement=function(e,t){var a,i,r=this._frame.getPoints(e),o=this._properties;if(r.x.length||r.y.length)if(r.x.length&&r.y.length);else if(o.default_form==viz.BAR||o.default_form==viz.NONE_SHAPE){var s=!0;r.y.length&&(s=!1);var l=o.getColor(e),_=o.getIntensity(e);o.default_form==viz.NONE_SHAPE&&(_=0);var n=o.default_border_color||l;a=(new Grape).lineStyle(o.default_border_width,n,o.default_border_intensity).beginFill(l,_);var h=this._frame._bar_width;if(o.default_form==viz.NONE_SHAPE&&(h=1),s){var d;r.x[1]<r.x[0]?(d=r.x[0]-r.x[1],a.x(r.x[0]-d/2).y(r.y),a.rect(-d/2,-r.width*(h/2),d,r.width*h)):(d=r.x[1]-r.x[0],a.x(r.x[0]+d/2).y(r.y),a.rect(-d/2,-r.width*(h/2),d,r.width*h)),a._data_form_vp={form:"bar",orientation:"horizontal",width:d,height:r.width*h}}else{var m;r.y[0]<r.y[1]?(m=r.y[1]-r.y[0],a.x(r.x).y(r.y[1]-m/2),a.rect(-r.width*(h/2),-m/2,r.width*h,m)):(m=r.y[0]-r.y[1],a.x(r.x).y(r.y[1]+m/2),a.rect(-r.width*(h/2),-m/2,r.width*h,m)),a._data_form_vp={form:"bar",orientation:"vertical",width:r.width*h,height:m}}o.default_form==viz.NONE_SHAPE&&(a._ishiddenbar=!0,a._data_form_vp.form="hiddenbar",a._data_form_vp.y2=Math.max(r.y[0],r.y[1]),a._data_form_vp.y=Math.min(r.y[0],r.y[1])),i=o.getTooltip(e,t),""!=i&&a.addChild(new Grape("title").text(i))}else r.y.length&&(a=o.getFormGrape(o.getForm(e),o.getArea(e),o.getColor(e),o.getIntensity(e)).x(r.x).y(Math.min(r.y[0],r.y[1])),a._data_form_vp.y2=Math.min(r.y[0],r.y[1]),a._data_form_vp.y=Math.max(r.y[0],r.y[1]),a.area_size=o.getArea(e),i=o.getTooltip(e,t),""!=i&&a.addChild(new Grape("title").text(i)),this._frame.zoomable&&(a.addClass("nonscalable"),this.updateZoomAutoFocusBox(a)));else o.default_form==viz.FILLED_RECTANGLE?(a=(new Grape).beginFill(o.getColor(e),o.getIntensity(e)).lineStyle(o.default_border_width,n,o.default_border_intensity),a.rect(-r.width/2+o.default_border_width/2,-r.height/2+o.default_border_width/2,r.width-o.default_border_width,r.height-o.default_border_width),a.x(r.x).y(r.y),a._data_form_vp={form:"filled_rectangle",width:r.width,height:r.height},a._is_filled_rectangle=!0,i=o.getTooltip(e,t),""!=i&&a.addChild(new Grape("title").text(i))):(a=o.getFormGrape(o.getForm(e),o.getArea(e),o.getColor(e),o.getIntensity(e)).x(r.x).y(r.y),a.area_size=o.getArea(e),i=o.getTooltip(e,t),""!=i&&a.addChild(new Grape("title").text(i)),this._frame.zoomable&&(a.addClass("nonscalable"),this.updateZoomAutoFocusBox(a)));if(1==o.countVariables(viz.UNIT)){var f=o.firstVariable(viz.UNIT),p=e;o.view.filterWrapper(a,f,p)}else o.view.filterWrapper(a,null,e);return this.addLink(a,e),this._frame.addToGraphHandler(a,e),this.addLabel(a,e),this.addConnection(a,e),a},viz.Elements.fn.drawGraphLinks=function(){var e=this;if(this._dataset.edges&&this._frame.graph_handler){for(var t=this._dataset.edges.source_link_var,a=this._dataset.edges.target_link_var,i=0;i<this._dataset.edges.length;i++){var r=this._dataset.edges.row(i),o=r[t]+"",s=r[a]+"";if(this._frame.graph_handler[o]&&this._frame.graph_handler[s]){var l=new Grape;l._linksrgr=this._frame.graph_handler[o].elm,l._linksrgr._edgesinout=l._linksrgr._edgesinout||[],l._linksrgr._edgesinout.push(l),l._linktggr=this._frame.graph_handler[s].elm,l._linktggr._edgesinout=l._linktggr._edgesinout||[],l._linktggr._edgesinout.push(l),l._vizrowvalue=r,l.redrawaslink=function(){this.clear();var t=this._linksrgr,a=this._linktggr,i={x:t.x(),y:t.y()},r={x:a.x(),y:a.y()},o=t.scale(),s=t._data_form_vp.radius*o,l=a._data_form_vp.radius*o,_=raceme.distance(i,r);if(_>s+l){var n=e._properties.vpedges,h=raceme.rect2polar(r.x-i.x,r.y-i.y),d=raceme.rect2polar(i.x-r.x,i.y-r.y),m=raceme.polar2rect(s,h.angle),f=raceme.polar2rect(l,d.angle);i.x+=m.x,i.y+=m.y,r.x+=f.x,r.y+=f.y,this.lineStyle(n.getWidth(this._vizrowvalue)*o,n.getColor(this._vizrowvalue),n.getIntensity(this._vizrowvalue)),this.line(i.x,i.y,r.x,r.y)}},l.addClass("forceredrawelement"),l._is_graph_link=!0,this._properties.view.filterWrapper(l,null,[this._frame.graph_handler[o].row,this._frame.graph_handler[s].row]),l._force_redraw=function(){this.redrawaslink()},this.linksgroup.push(l)}}this.linksgroup.length>0&&(this.linksgroup.addTo(this.linksgr),this.linksgr.addTo(this.gr).toBack())}},viz.Elements.fn.updateZoomAutoFocusBox=function(e){if(this._frame.zoom_auto_focus){var t=e.getBBox();this._frame.zoom_auto_focus_box?(this._frame.zoom_auto_focus_box.x=Math.min(this._frame.zoom_auto_focus_box.x,t.x),this._frame.zoom_auto_focus_box.y=Math.min(this._frame.zoom_auto_focus_box.y,t.y),this._frame.zoom_auto_focus_box.x2=Math.max(this._frame.zoom_auto_focus_box.x2,t.x+t.width),this._frame.zoom_auto_focus_box.y2=Math.max(this._frame.zoom_auto_focus_box.y2,t.y+t.height)):this._frame.zoom_auto_focus_box={x:t.x,y:t.y,x2:t.x+t.width,y2:t.y+t.height}}},viz.Elements.fn.addLink=function(e,t){var a=this,i=this._properties.getHref(t);""!=i&&e.fixedclic(function(){"_blank"==a._properties.default_link_target?window.open(a._properties.base_url+i):window.location.href=a._properties.base_url+i})},viz.Elements.fn.addLabel=function(e,t){var a=this._properties.getLabel(t);a&&(a.x(e.x()),a.y(e.y()),e._labelviz=a,e._labelsgroup=this.labelsgroup,a._elmviz=e,a._tmpbbox=a.getBBox(),this.labelsgroup.push(a),this._frame.zoomable&&a.addClass("nonscalable"))},viz.Elements.fn.addConnection=function(e,t){if(this._properties.countVariables(viz.CONNECTION)>0){this.connectionReferences=this.connectionReferences||{};var a;a=1==this._properties.countVariables(viz.UNIT)?t[this._properties.firstVariable(viz.UNIT)]:this._properties.countVariables(viz.HUE)>0?t[this._properties.firstVariable(viz.HUE)]:2==this._properties.countVariables(viz.POS_Y)&&this._properties.firstVariable(viz.POS_Y)!=this._properties.firstVariable(viz.CONNECTION)&&this._dataset.isCategorical(this._properties.firstVariable(viz.POS_Y))?t[this._properties.firstVariable(viz.POS_Y)]:2==this._properties.countVariables(viz.POS_X)&&this._properties.firstVariable(viz.POS_X)!=this._properties.firstVariable(viz.CONNECTION)&&this._dataset.isCategorical(this._properties.firstVariable(viz.POS_X))?t[this._properties.firstVariable(viz.POS_X)]:"all";var i=t[this._properties.firstVariable(viz.CONNECTION)];this.connectionReferences[a]=this.connectionReferences[a]||{},this.connectionReferences[a][i]=this.connectionReferences[a][i]||{},this.connectionReferences[a][i].gr=e,this.connectionReferences[a][i].row=t}},viz.Elements.fn.getConnectionGrape=function(e){var t,a,i=new Grape,r=new Grape,o=this._properties,s=o.getSettings(o.firstVariable(viz.CONNECTION),viz.CONNECTION,"connection_type");0==s&&(s="line");for(var l,_=raceme.dV(o.getSettings(o.firstVariable(viz.CONNECTION),viz.CONNECTION,"alpha"),.5),n=0;n<this.connectionValues.length;n++){var h=this.connectionValues[n],d=this.connectionValues[n+1];if(e[h]&&e[d]){var m=e[h].gr,f=m._data_form_vp,p=e[d].gr,c=p._data_form_vp,v=m.x(),g=m._data_form_vp.y||m.y(),u=p.x(),b=p._data_form_vp.y||p.y(),x=e[h].row,y=(e[d].row,o.getColor(x));if(l=o.getIntensity(x),l=o.getSettings(o.firstVariable(viz.CONNECTION),viz.CONNECTION,"alpha")===!1?Math.max(0,.5*l):Math.max(0,l*_),"bar"==f.form){var z,w,E,C,V,N,T,I;"vertical"==f.orientation?u>=v?(z=v+f.width/2,w=g-f.height/2,E=z,C=g+f.height/2,V=u-c.width/2,N=b-c.height/2,T=V,I=b+c.height/2):(z=u+c.width/2,w=b-c.height/2,E=z,C=b+c.height/2,V=v-f.width/2,N=g-f.height/2,T=V,I=g+f.height/2):b>=g?(z=v-f.width/2,w=g+f.height/2,E=u-c.width/2,C=b-c.height/2,V=v+f.width/2,N=w,T=u+c.width/2,I=C):(z=u-c.width/2,w=b+c.height/2,E=v-f.width/2,C=g-f.height/2,V=u+c.width/2,N=w,T=v+f.width/2,I=C),t=new Grape,t.lineStyle(0,y,l),t.beginFill(y,l),t.beginPath(!0).moveTo(Math.round(z),w).lineTo(Math.round(V),N).lineTo(Math.round(T),I).lineTo(Math.round(E),C).endPath(),t.addTo(r)}else("line"==s||"both"==s)&&(t||(t=new Grape,t.lineStyle(o.getWidth(x),y,o.getIntensity(x),"butt","round"),t.beginFill("none"),t.beginPath(),t.moveTo(v,g)),t.lineTo(u,b)),("area"==s||"both"==s)&&(a||(a=new Grape,a.lineStyle(0),a.beginFill(y,l),a.beginPath(!0),a.moveTo(v,g)),a.lineTo(u,b))}else if(e[h]&&(t||a)&&"bar"!=e[h].gr._data_form_vp.form&&(("line"==s||"both"==s)&&(t.endPath(),t.addTo(i),t=null),"area"==s||"both"==s))for(var G=n;G>=0;G--){var O=this.connectionValues[G],k=this.connectionValues[G-1];if(!e[O]||!e[k]){a.lineTo(e[O].gr.x(),e[O].gr._data_form_vp.y2),a.endPath(),a.addTo(r).toBack(),a=null;break}a.lineTo(e[O].gr.x(),e[O].gr._data_form_vp.y2)}}return[i,r]},viz.Elements.fn.drawBackgroundElement=function(e,t){var a=this._properties,i=a.firstVariable(viz.UNIT),r=e[i],o=this._frame._map.getCountryGrape(r);if(o){o.attr("fill",a.getColor(e)),o.opacity(a.getIntensity(e)),a.countVariables(viz.AREA)>0&&(o.valuebyarea=a.getArea(e));var s=a.getTooltip(e,t);if(""!=s||a.countVariables(viz.LABEL)>0){var l=this._frame._map.getCentroid(r);""!=s&&(o.addChild(new Grape("title").text(s)),o.attr("data-center-x",l.x).attr("data-center-y",l.y),o.enableEvents(!0)),a.countVariables(viz.LABEL)>0&&(o._data_form_vp={form:"country",radius:1,x:l.x,y:l.y},this.addLabel(o,e))}this._frame.zoom_auto_focus&&(o._need_zoom_autofocus=!0),a.view.filterWrapper(o,i,e),this.addLink(o,e)}},viz.Elements.fn.drawPie=function(e,t,a,i){var r=new Grape;r.x(t).y(a);var o=this._properties,s=i*o.default_donut_padding,l=o.countVariables(viz.DIVISION),_=(i-s)/l,n=e.sum(o.firstVariable(viz.ANGLE)),h=e.sums();r.area_size=i;var d=!0;this._properties.countVariables(viz.UNIT)>0&&this._properties.countVariables(viz.LABEL)&&this._properties.firstVariable(viz.UNIT)==this._properties.firstVariable(viz.LABEL)&&(r._data_form_vp={form:"circle",radius:i},d=!1);var m=this.drawSlice(e,n,-90,0,s,_,h,r,d);return r.addChild(m.grape).addChild(new Grape("defs").addChild(m.pielabelsdef)).addChild(m.pielabels),this._frame.zoomable&&(r.addClass("nonscalable"),this.updateZoomAutoFocusBox(r)),!d&&e.length>0&&this.addLabel(r,e.row(0)),r},viz.Elements.fn.drawSlice=function(e,t,a,i,r,o,s,l,_){"boolean"!=typeof _&&(_=!0);var n=new Grape,h=new GrapeGroup,d=new Grape("defs"),m=this._properties,f=m.countVariables(viz.DIVISION),p=m.allVariables(viz.DIVISION)[i],c=m.firstVariable(viz.ANGLE),v=e.unique(p,m.orderRule(p)),g=r+o/2,u=m.getSettings(p,viz.DIVISION,"legend");u="undefined"==typeof u||1!=u&&"true"!=u?!1:!0;for(var b=0;b<v.length;b++){var x=v[b],y=e.rows(p,v[b]),z=viz.Utils.map(y.sum(c),0,t,0,360),w=y.row(0);if(w[c]=y.sum(c),"null"==x);else{n.beginFill(m.getColor(w),m.getIntensity(w)),m.default_border_color&&z>2&&360>z?n.lineStyle(m.default_border_width,m.default_border_color,m.default_border_intensity):n.lineStyle(m.default_border_width,m.default_border_color,0),n.pieSlice(r,r+o-1,a,a+z);var E=n.lastChild();_&&(E._data_form_vp={form:"slice",radius:r+o,parent:l,xin:raceme.polar2rect(g,a+z/2).x,yin:raceme.polar2rect(g,a+z/2).y,xout:raceme.polar2rect(r+o,a+z/2).x,yout:raceme.polar2rect(r+o,a+z/2).y,init_angle:a,end_angle:a+z,angle:a+z/2}),E._viz_filter_classes=[],E._viz_filter_interactions=null,m.view.filterWrapper(E,p,y);var C=m.getTooltip(w,s);if(f>1||""!=C){f>1?E.addChild(new Grape("title").text(x+C)):""!=C&&E.addChild(new Grape("title").text(C));var V=raceme.polar2rect(g,a+z/2).x,N=raceme.polar2rect(g,a+z/2).y;E.attr("data-center-x",V),E.attr("data-center-y",N)}_&&this.addLabel(E,w)}if("null"!=x&&u){var T=raceme.label(x,0,0,m.default_label_color,m.default_label_size,"center"),I=raceme.arc_length(g,z),G=T.getBBox();if(G.width<I&&G.height<o){var O=viz.Utils.generateId(),k=new Grape("text");k.enableEvents(!1),k.attr("font-size",m.default_label_size).attr("fill",m.default_label_color),k.addChild(new Grape("textPath").attr("href","#"+O).attr("startOffset","50%").attr("text-anchor","middle").style("dominant-baseline","central").text(x)),h.push(k);var S=raceme.polar2rect(g,a).x,A=raceme.polar2rect(g,a).y,P=raceme.polar2rect(g,a+Math.min(z,359)).x,B=raceme.polar2rect(g,a+Math.min(z,359)).y,L=0;z>180&&(L=1);a>170||a+z>170&&a+z-170>170-a||0>a&&Math.abs(a)>z/2?d.beginPath(!1).moveTo(S,A).arcTo(P,B,g,L).endPath():d.beginPath(!1).moveTo(P,B).arcTo(S,A,g,L,0).endPath(),d.lastChild().id(O)}else if(G.width<o){var M=g-G.width/2,R=raceme.polar2rect(M,a),U=raceme.polar2rect(M,a+z);if(raceme.distance(R,U)>G.height){var H=a+.5*z;T.x(raceme.polar2rect(g,H).x),T.y(raceme.polar2rect(g,H).y),90>H||H>270?T.rotation(H):T.rotation(H+180),h.push(T.enableEvents(!1))}}}if(m.countVariables(viz.DIVISION)-1>i){var F=this.drawSlice(y,t,a,i+1,r+o,o,s,l,_);n.addChild(F.grape),h.push(F.pielabels),F.pielabelsdef.addTo(d)}a+=z}return{grape:n,pielabels:h,pielabelsdef:d.getChildren()}},viz.Elements.fn.getGrape=function(){return this.gr};