var viz=viz||{};
viz.Player=function(b,a,e){this._data_type=e;this._callbacks=[];this._callbacks_length=0;this._animation_on=!0;this._time_transition=150;this._currentvalue=0;this.font_size=14;this._values=b;this._width=a;this._width_slider=a-60;this.gr=new Grape;this.playicon=new Grape;this.pauseicon=new Grape;this.slideline=new Grape;this.control=new Grape;var c=this;this.playicon.addTo(this.gr);this.pauseicon.addTo(this.gr);this.slideline.addTo(this.gr);this.control.addTo(this.gr);this.playicon.beginFill("white",0).rect(0,
0,40,40).beginFill("rgb(79,194,101)",1).lineStyle(3,"rgb(79,194,101)",1,"round","round").beginPath(!0).moveTo(12,10).lineTo(28,20).lineTo(12,30).endPath();this.playicon.clic(function(){c.play()});this.pauseicon.beginFill("white",0).rect(0,0,40,40).beginFill("rgb(79,194,101)",1).lineStyle(0).rect(11,10,7,20).rect(22,10,7,20);this.pauseicon.hide();this.pauseicon.clic(function(){c.pause()});this.slideline.beginFill("rgb(240,240,240)").rect(0,18,this._width_slider,4,2,2).x(60);this._min=b[0];this._max=
b[b.length-1];if("MM"==this._data_type||"dd-MM"==this._data_type||"MM-YYYY"==this._data_type||"YYYY-MM"==this._data_type)this._min=viz.Utils.date(this._min,this._data_type).strformat(this._data_type,{month:"short"}),this._max=viz.Utils.date(this._max,this._data_type).strformat(this._data_type,{month:"short"});this.labelcolor="rgb(120,120,120)";this.labelmin=raceme.label(this._min,60,40-this.font_size,this.labelcolor,this.font_size,"left","bottom").enableEvents(!1).addTo(this.slideline);this.labelmax=
raceme.label(this._max,60+this._width_slider,40-this.font_size,this.labelcolor,this.font_size,"right","bottom").enableEvents(!1).addTo(this.slideline);this.labelvalue=raceme.label("",60,40,this.labelcolor,this.font_size,"center").enableEvents(!1).addTo(this.slideline);this.control.beginFill("white",0).circle(0,0,20).beginFill("rgb(79,194,101)",1).lineStyle(2,"white",1).circle(0,0,9);this.control.x(60).y(20);this.updateControl();this.control.drag(function(b){c.pause()},function(b){var a=c.gr.seed.ownerSVGElement.createSVGPoint();
a.x=b.clientX;a.y=b.clientY;a=a.matrixTransform(c.gr.seed.ownerSVGElement.getScreenCTM().inverse());a.x-=c.slideline.getBBox().x;0>a.x?c._currentvalue=0:a.x>c._width_slider?c._currentvalue=c._values.length-1:(b=c._width_slider/(c._values.length-1),a=parseInt((a.x+b/2)/b),a=Math.max(a,0),a=Math.min(a,c._values.length-1),a!=c._currentvalue&&(c._currentvalue=a,c.updateData()));c.updateControl()},function(a){})};viz.Player.fn=viz.Player.prototype;viz.Player.fn.getGrape=function(){return this.gr};
viz.Player.fn.time_transition=function(b){"undefined"!==typeof b&&null!==b&&(this._time_transition=b);return this};viz.Player.fn.play=function(){var b=0;this._currentvalue==this._values.length-1&&(this._currentvalue=0,this.updateData(),b=this._time_transition);"undefined"===typeof this.animatables&&(this.animatables=(new Grape(this.playicon.seed.ownerSVGElement)).by("class:animatable_viz"));this.playicon.hide();this.pauseicon.show();this._animation_on=!0;this.step(b)};
viz.Player.fn.pause=function(){this._animation_on=!1;this.playicon.show();this.pauseicon.hide()};
viz.Player.fn.updateControl=function(){var b=this._width_slider/(this._values.length-1);this.general_animation&&this.general_animation.stop();this.control.x(60+b*this._currentvalue);if(0==this._currentvalue||this._currentvalue==this._values.length-1)this.labelmin.show(),this.labelmax.show(),this.labelvalue.hide();else{this.labelmin.hide();this.labelmax.hide();this.labelvalue.show();var a=this._values[this._currentvalue];if("MM"==this._data_type||"dd-MM"==this._data_type||"MM-YYYY"==this._data_type||
"YYYY-MM"==this._data_type)a=viz.Utils.date(a,this._data_type).strformat(this._data_type,{month:"short"});this.labelvalue.text(a);this.labelvalue.x(b*this._currentvalue);b=this.labelvalue.getBBox();0>this.labelvalue.x()-b.width/2?this.labelvalue.x(b.width/2):this.labelvalue.x()+b.width/2>this._width_slider&&this.labelvalue.x(this._width_slider-b.width/2)}};
viz.Player.fn.updateData=function(){"undefined"===typeof this.animatables&&(this.animatables=(new Grape(this.playicon.seed.ownerSVGElement)).by("class:animatable_viz"));for(var b=0;b<this.animatables.length;b++){var a=this.animatables.item(b);if(a._data_animation[this._currentvalue]){var e=a._data_animation[this._currentvalue];a.attr("r",e.r);a.attr("cx",e.cx);a.attr("cy",e.cy);a.fill(e.fill);a.attr("fill-opacity",e["fill-opacity"]);a._data_form_vp={form:"animatedcircle",radius:e.r,x:e.cx,y:e.cy}}else a.attr("r",
0),a.attr("cx",0),a.attr("cy",0),a.attr("fill-opacity",0),a._data_form_vp={form:"animatedcircle",radius:0,x:0,y:0}}if(0<this._callbacks_length)for(b=0;b<this._callbacks_length;b++)this._callbacks[b].call(this)};
viz.Player.fn.step=function(b){if(this._animation_on){for(var a=this,e=[],c=[],h=[],k=[],l=[],d=0;d<this.animatables.length;d++){var f=this.animatables.item(d);if(f._data_animation[this._currentvalue+1]){var g=f._data_animation[this._currentvalue+1];c[d]=g.cy;e[d]=g.cx;"undefined"===typeof f._data_animation[this._currentvalue]&&(f.attr("cx",e[d]),f.attr("cy",c[d]));h[d]=g.r;k[d]=g["fill-opacity"];l[d]=g.fill;f._data_form_vp={form:"animatedcircle",radius:g.r,x:e[d],y:c[d]}}else e[d]=0,c[d]=0,f._data_animation[this._currentvalue]&&
(e[d]=f._data_animation[this._currentvalue].cx,c[d]=f._data_animation[this._currentvalue].cy),h[d]=0,k[d]=0,l[d]=f.fill(),f._data_form_vp={form:"animatedcircle",radius:0,x:0,y:0}}b&&a.updateControl();this.general_animation=this.animatables.animate(this._time_transition,b).attr("cx",e).attr("cy",c).attr("r",h).attr("fill-opacity",k).fill(l).done(function(){a._currentvalue++;a.updateControl();a._currentvalue<a._values.length-1?a.step():a.pause()}).meanwhile(function(){if(0<a._callbacks_length)for(var b=
0;b<a._callbacks_length;b++)a._callbacks[b].call(a)})}};viz.Player.fn.addCallback=function(b){this._callbacks.push(b);this._callbacks_length++};
