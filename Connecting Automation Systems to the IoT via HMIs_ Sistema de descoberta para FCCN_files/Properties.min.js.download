var viz=viz||{};viz.POS_X=0,viz.POS_Y=1,viz.LENGTH=2,viz.AREA=3,viz.LINK=4,viz.HUE=5,viz.INTENSITY=6,viz.SHAPE=7,viz.WIDTH=8,viz.BLUR=9,viz.SMALL_MULTIPLES=10,viz.ANIMATION=11,viz.LABEL=12,viz.TOOLTIP=13,viz.CONNECTION=14,viz.UNIT=15,viz.ANGLE=16,viz.DIVISION=17,viz.PropertyNames={AXIS_X:viz.POS_X,AXIS_Y:viz.POS_Y,LENGTH:viz.LENGTH,AREA:viz.AREA,LINK:viz.LINK,COLOR:viz.HUE,ALPHA:viz.INTENSITY,SHAPE:viz.SHAPE,WIDTH:viz.WIDTH,BLUR:viz.BLUR,MULTIPLES:viz.SMALL_MULTIPLES,ANIMATION:viz.ANIMATION,LABEL:viz.LABEL,TOOLTIP:viz.TOOLTIP,CONNECTION:viz.CONNECTION,UNIT:viz.UNIT,DIVISION:viz.DIVISION,ANGLE:viz.ANGLE},viz.NONE_SHAPE=-1,viz.DISK=0,viz.BOX=1,viz.TRI=2,viz.CROSS=3,viz.STAR=4,viz.DIAMOND=5,viz.FILLED_DISK=6,viz.FILLED_BOX=7,viz.FILLED_TRI=8,viz.FILLED_DIAMOND=9,viz.GEO_SHAPE=10,viz.VERTICAL_LINE=11,viz.HORIZONTAL_LINE=12,viz.BAR=13,viz.FILLED_RECTANGLE=14,viz.SHAPE_NAMES={none:viz.NONE_SHAPE,disk:viz.DISK,box:viz.BOX,tri:viz.TRI,cross:viz.CROSS,star:viz.STAR,diamond:viz.DIAMOND,"filled disk":viz.FILLED_DISK,"filled box":viz.FILLED_BOX,"filled tri":viz.FILLED_TRI,"filled diamond":viz.FILLED_DIAMOND,geo:viz.GEO_SHAPE,"vertical line":viz.VERTICAL_LINE,"horizontal line":viz.HORIZONTAL_LINE,bar:viz.BAR,"filled rectangle":viz.FILLED_RECTANGLE},viz.PIE=0,viz.TREEMAP=1,viz.DONUT=2,viz.BOX_SEGMENTS=3,viz.RADIAL=4,viz.RADAR=5,viz.default_hues=["rgb(122,195,106)","rgb(90,155,212)","rgb(250,167,91)","rgb(158,103,171)","rgb(206,112,88)","rgb(215,127,180)","rgb(234,213,20)","rgb(28,145,149)","rgb(33,139,83)","rgb(115,115,115)"],viz.Properties=function(i,t){this.view=t,this._dataset=i,this._ds=this._dataset,this._properties=new viz.PData,this.default_intensity=1,this.default_area=144,this.default_hue="rgb(122,195,106)",this.default_form=viz.FILLED_DISK,this.default_division=0,this.default_bar_margins=.5,this.default_link_target="_self",this.base_url="",this.default_border_width=0,this.default_border_intensity=1,this.default_donut_padding=0,this.default_label_color="rgb(70,70,70)",this.default_inner_color="white",this.default_inner_alpha=0,this.default_label_size=14,this.default_label_pos="in",this.allow_label_overlap=!1,this.min_intensity=.2,this.max_intensity=1,this.default_width=1,this.min_width=1,this.max_width=8,this.min_area=0,this.max_area=1e4,this.min_hue="rgb(194,107,81)",this.max_hue="rgb(82,153,133)",this.min_animation=null,this.max_animation=null,this.hue_legend_division=7,this.groupby_rules={},this.legends_to_include=[],this.user_selected_colors={},"line"==this.connection_type,this.order_rules=[]},viz.Properties.fn=viz.Properties.prototype,viz.Properties.fn.link=function(i,t){if(var_n=i,"string"==typeof i&&(i=this._dataset.header.getId(i)),0==this._dataset.hasColumn(i))return this;if(!(t>=0&&17>=t))return this.debug("Invalid property value");if(this.isSet(i,t))return this.debug("Property value already assigned");if(t==viz.SHAPE&&this.countVariables(viz.ANIMATION)>0||t==viz.ANIMATION&&this.countVariables(viz.SHAPE)>0)return this.debug("SHAPE and ANIMATION are not compatible properties");if(0==this._dataset.isCategorical(i)&&(t==viz.UNIT||t==viz.SHAPE||t==viz.SMALL_MULTIPLES||t==viz.ANIMATION||t==viz.LINK||t==viz.DIVISION||t==viz.CONNECTION))return this.debug("Property ("+t+") not compatible with numeric variables ("+this._dataset.header.names[i]+")");if(1==this._dataset.isCategorical(i)&&(t==viz.LENGTH||t==viz.AREA||t==viz.BLUR))return this.debug("Property not compatible with categorical variables");if(t==viz.ANIMATION&&this.isOrdinal(i)===!1)return this.debug("Property only compatible with ordinal variables");if((t==viz.WIDTH||t==viz.INTENSITY)&&this.isOrdinal(i)===!1&&1==this._dataset.isCategorical(i))return this.debug("Property only compatible with ordinal or numeric variables");if(t==viz.AREA&&this.countVariables(viz.LENGTH)>0||t==viz.LENGTH&&this.countVariables(viz.AREA)>0)return this.debug("AREA and LENGTH are not compatibles");if((t==viz.UNIT||t==viz.SHAPE||t==viz.AREA||t==viz.HUE||t==viz.INTENSITY||t==viz.WIDTH||t==viz.BLUR||t==viz.ANIMATION||t==viz.SMALL_MULTIPLES||t==viz.CONNECTION||t==viz.LABEL||t==viz.LINK||t==viz.ANGLE)&&0!=this.countVariables(t))return this.debug("This property ("+t+") has been already assigned to another variable");if(null===this.orderRule(i)&&t==viz.DIVISION&&this.countVariables(viz.ANGLE)>0&&this.setOrderRule(i,this.firstVariable(viz.ANGLE)),t==viz.ANGLE&&this.countVariables(viz.DIVISION)>0)for(var e=0;e<this.countVariables(viz.DIVISION);e++){var s=this.allVariables(viz.DIVISION)[e];null===this.orderRule(s)&&this.setOrderRule(s,i)}return this._properties.add(i,t),this},viz.Properties.fn.remove_link=function(i,t){var e=t.toUpperCase();"undefined"!=typeof viz.PropertyNames[e]&&this._properties.remove(i,viz.PropertyNames[e])},viz.Properties.fn.setOrderRule=function(i,t){i=this._ds.header.getId(i),"string"==typeof t&&(t=this._ds.header.getId(t)),t.length?this.order_rules[i]={order_variable:i,ordered_items:t}:this.order_rules[i]={order_variable:t,ordered_items:[]}},viz.Properties.fn.orderRule=function(i){return i=this._ds.header.getId(i),"undefined"==typeof this.order_rules[i]?null:this.order_rules[i]},viz.Properties.fn.getTicks=function(i){return this._ds.getTicks(i,this.orderRule(i))},viz.Properties.fn.eachRowOrdered=function(i,t){this._ds.eachRowOrdered(i,t,this.orderRule(t))},viz.Properties.fn.debug=function(i){return console.log(i),this},viz.Properties.fn.isOrdinal=function(i){return this._dataset.isDateType(i)?!0:!1},viz.Properties.fn.countVariables=function(i){return this._properties.keys(i).length},viz.Properties.fn.countProperties=function(i){return i=this._ds.header.getId(i),this._properties.values(i).length},viz.Properties.fn.setSettings=function(i,t,e,s){return i=this._ds.header.getId(i),i>=0&&(this._properties.settings(i,t,e,s),"min"==e?"number"==typeof s?(t==viz.AREA&&(this.min_area=s),t==viz.INTENSITY&&s>=0&&1>=s&&(this.min_intensity=s),t==viz.ANIMATION&&(this.min_animation=s.toString()),t==viz.WIDTH&&(this.min_width=s)):"string"==typeof s&&(t==viz.HUE&&(this.min_hue=s),t==viz.ANIMATION&&(this.min_animation=s)):"min_value"==e?"number"==typeof s?(t==viz.AREA&&(this.min_area_value=s),t==viz.INTENSITY&&(this.min_intensity_value=s),t==viz.ANIMATION&&(this.min_animation=s.toString()),t==viz.HUE&&(this.min_hue_value=s)):"string"==typeof s&&t==viz.ANIMATION&&(this.min_animation=s):"max"==e?"number"==typeof s?(t==viz.AREA&&(this.max_area=s),t==viz.INTENSITY&&s>=0&&1>=s&&(this.max_intensity=s),t==viz.ANIMATION&&(this.max_animation=s.toString()),t==viz.WIDTH&&(this.max_width=s)):"string"==typeof s&&(t==viz.HUE&&(this.max_hue=s),t==viz.ANIMATION&&(this.max_animation=s)):"max_value"==e?"number"==typeof s?(t==viz.AREA&&(this.max_area_value=s),t==viz.INTENSITY&&(this.max_intensity_value=s),t==viz.ANIMATION&&(this.max_animation=s.toString()),t==viz.HUE&&(this.max_hue_value=s)):"string"==typeof s&&t==viz.ANIMATION&&(this.max_animation=s):"middle"==e?"string"==typeof s&&t==viz.HUE&&(this.middle_hue=s):"middle_value"==e?"number"==typeof s&&t==viz.HUE&&(this.middle_hue_value=s):"legend"==e?(s===!0||"true"===s)&&t!==viz.DIVISION&&this.legends_to_include.push(t):"legend_division"==e?"number"==typeof s&&(s=parseInt(s),s=Math.max(2,s),t==viz.HUE&&(this.hue_legend_division=s)):"type"==e&&t==viz.CONNECTION&&(this.connection_type=s)),this},viz.Properties.fn.getSettings=function(i,t,e){return i=this._ds.header.getId(i),this._properties.settings(i,t,e)},viz.Properties.fn.firstVariable=function(i){return this._properties.firstKey(i)},viz.Properties.fn.secondVariable=function(i){return this._properties.secondKey(i)},viz.Properties.fn.lastVariable=function(i){var t=this._properties.keys(i);return t[t.length-1]},viz.Properties.fn.allVariables=function(i){return this._properties.keys(i)},viz.Properties.fn.isSet=function(i,t){return this._properties.isSet(i,t)},viz.Properties.fn.getFormGrape=function(i,t,e,s){var r,a,n=new Grape;if(i==viz.NONE_SHAPE)return n.beginFill("white",0).lineStyle(0).circle(0,0,raceme._radius(t)),n._data_form_vp={form:"circle",radius:0},n._is_invisible=!0,n;if(i==viz.BAR&&(i=viz.FILLED_BOX),i==viz.FILLED_DISK||i==viz.FILLED_BOX||i==viz.FILLED_DIAMOND||i==viz.FILLED_TRI||i==viz.VERTICAL_LINE||i==viz.HORIZONTAL_LINE){var h=this.default_border_color||e;n.beginFill(e,s).lineStyle(this.default_border_width,h,this.default_border_intensity)}else n.beginFill(this.default_inner_color,this.default_inner_alpha).lineStyle(2,e,s);if(i==viz.DISK||i==viz.FILLED_DISK)r=raceme._radius(t),i==viz.DISK&&r>=2&&(r-=1),n.circle(0,0,r),n._data_form_vp={form:"circle",radius:r};else if(i==viz.BOX||i==viz.FILLED_BOX)a=viz.Utils.round(Math.sqrt(t),3),i==viz.BOX&&a>=3&&(a-=2),n.rect(-a/2,-a/2,a,a),n._data_form_vp={form:"box",radius:Math.sqrt(2)*a/2};else if(i==viz.DIAMOND||i==viz.FILLED_DIAMOND)a=Math.sqrt(2*t),i==viz.DIAMOND&&a>=3&&(a-=2),n.beginPath(!0).moveTo(0,.5*-a).lineTo(.5*a,0).lineTo(0,.5*a).lineTo(.5*-a,0).endPath(),n._data_form_vp={form:"diamond",radius:a/2};else if(i==viz.TRI||i==viz.FILLED_TRI){a=Math.sqrt(t/(Math.sqrt(3)/4)),i==viz.TRI&&a>=3&&(a-=2);var o=Math.sqrt(3)/2*a;n.beginPath(!0).moveTo(0,-o/3*2+o/6).lineTo(a/2,o/3+o/6).lineTo(-a/2,o/3+o/6).endPath(),n._data_form_vp={form:"tri",radius:.75*o}}else i==viz.CROSS?(a=Math.sqrt(2*t),a>=3&&(a-=2),n.moveTo(0,.5*-a).lineTo(0,.5*a).moveTo(.5*a,0).lineTo(.5*-a,0),n._data_form_vp={form:"cross",radius:a/2}):i==viz.STAR?(a=Math.sqrt(2*t),a>=3&&(a-=2),n.moveTo(0,.5*-a).lineTo(0,.5*a),a=Math.sqrt(t),n.moveTo(.5*-a,.5*-a).lineTo(.5*a,.5*a).moveTo(.5*-a,.5*a).lineTo(.5*a,.5*-a),n._data_form_vp={form:"star",radius:.75*a}):i==viz.VERTICAL_LINE?(a=Math.sqrt(2*t),n.lineStyle(2,"white",0),n.rect(-1,.5*-a,2,a),n._data_form_vp={form:"vertical_line",radius:a/2}):i==viz.HORIZONTAL_LINE&&(a=Math.sqrt(2*t),n.lineStyle(2,"white",0),n.rect(.5*-a,-1,a,2),n._data_form_vp={form:"horizontal_line",radius:a/2});return n},viz.Properties.fn.getArea=function(i){if(0==this.countVariables(viz.AREA))return this.default_area;var t,e=this.firstVariable(viz.AREA);t="number"==typeof i?i:i[e];var s=this._ds.min(e),r=this._ds.max(e);return"number"==typeof this.min_area_value&&(s=this.min_area_value),"number"==typeof this.max_area_value&&(r=this.max_area_value),s==r?this.max_area:Math.max(viz.Utils.map(t,s,r,this.min_area,this.max_area),0)},viz.Properties.fn.getIntensity=function(i){if(0==this.countVariables(viz.INTENSITY))return this.default_intensity;var t=this.firstVariable(viz.INTENSITY);if(this._dataset.isDateType(t)){var e=viz.Utils.date(this._ds.min(t),this._dataset.columnType(t)).getTime(),s=viz.Utils.date(this._ds.max(t),this._dataset.columnType(t)).getTime(),r=viz.Utils.date(i[t],this._dataset.columnType(t)).getTime();return viz.Utils.map(r,e,s,this.min_intensity,this.max_intensity)}var a=this._ds.min(t),n=this._ds.max(t);"number"==typeof this.min_intensity_value&&(a=this.min_intensity_value),"number"==typeof this.max_intensity_value&&(n=this.max_intensity_value);var h=i[t];return h=Math.max(h,a),h=Math.min(h,n),viz.Utils.map(h,a,n,this.min_intensity,this.max_intensity)},viz.Properties.fn.getWidth=function(i){if(0==this.countVariables(viz.WIDTH))return this.default_width;var t=this.firstVariable(viz.WIDTH),e=i[t];if(this.isOrdinal(t))return this.default_width;var s=this._ds.min(t),r=this._ds.max(t);return viz.Utils.map(e,s,r,this.min_width,this.max_width)},viz.Properties.fn.getHref=function(i){if(0==this.countVariables(viz.LINK))return"";var t=this.firstVariable(viz.LINK);return"string"!=typeof i[t]&&(i[t]=i[t].toString()),i[t]},viz.Properties.fn.getLabel=function(i){if(0==this.countVariables(viz.LABEL))return null;var t=this.firstVariable(viz.LABEL),e=i[t];return"string"!=typeof e&&(e=e.toString()),raceme.label(e,0,0,"rgb(20,20,20)",14,"center").enableEvents(!1)},viz.Properties.fn.getTooltip=function(i,t){if(0==this.countVariables(viz.TOOLTIP))return"";for(var e="",s=this.allVariables(viz.TOOLTIP),r=0;r<s.length;r++){var a=s[r],n=i[a];if("string"!=typeof n&&(n=n.toString()),"string"==typeof this._properties.settings(a,viz.TOOLTIP,"tooltip_format")&&(n=this._properties.settings(a,viz.TOOLTIP,"tooltip_format").replace("[value]",n),"undefined"!=typeof t&&t[a]>0&&-1!=n.indexOf("[percentage]"))){var h=100*i[a]/t[a];h=.01>h?"<0.01%":viz.Utils.round(h,2)+"%",n=n.replace("[percentage]",h)}e+=n}return e},viz.Properties.fn.getForm=function(i){if(0==this.countVariables(viz.SHAPE))return this.default_form;var t=this.firstVariable(viz.SHAPE);if("undefined"==typeof this._ds._variables_forms){this._ds._variables_forms={};for(var e=this._ds.unique(t),s=0,r=0;r<e.length;r++)this._ds._variables_forms[e[r]]=s,s++,s>9&&(s=0)}return this._ds._variables_forms[i[t]]},viz.Properties.fn.getColor=function(i){if(0==this.countVariables(viz.HUE))return this.default_hue;var t,e=this.firstVariable(viz.HUE);if(t="string"==typeof i||"number"==typeof i?i:i[e],!this._ds.isCategorical(e)||this._ds.isDateType(e)){var s,r,a=!1;if(this._ds.isCategorical(e)?(a=!0,t=viz.Utils.date(t,this._dataset.columnType(e)).getTime(),s=viz.Utils.date(this._ds.min(e),this._dataset.columnType(e)).getTime(),r=viz.Utils.date(this._ds.max(e),this._dataset.columnType(e)).getTime()):(s=this._ds.min(e),r=this._ds.max(e)),"undefined"!=typeof this.min_hue_value&&(s=a?viz.Utils.date(this.min_hue_value,this._dataset.columnType(e)).getTime():this.min_hue_value),"undefined"!=typeof this.max_hue_value&&(r=a?viz.Utils.date(this.max_hue_value,this._dataset.columnType(e)).getTime():this.max_hue_value),"undefined"!=typeof this.middle_hue){var n;return"undefined"!=typeof this.middle_hue_value?(n=a?viz.Utils.date(this.maiddle_hue_value,this._dataset.columnType(e)).getTime():this.middle_hue_value,n=Math.max(n,s),n=Math.min(n,r)):n=s+(r-s)/2,n>t?raceme._mapColors(t,s,n,this.min_hue,this.middle_hue):raceme._mapColors(t,n,r,this.middle_hue,this.max_hue)}return raceme._mapColors(t,s,r,this.min_hue,this.max_hue)}if("undefined"==typeof this._variables_hues){this._variables_hues={};for(var h=this._ds.unique(e),o=0,v=0;v<h.length;v++)raceme._getRGB(this.user_selected_colors[h[v]])?this._variables_hues[h[v]]=this.user_selected_colors[h[v]]:(this._variables_hues[h[v]]=viz.default_hues[o],o++),o>=viz.default_hues.length&&(o=0)}return this._variables_hues[t]},viz.Properties.fn.init=function(){var i=this;if(1==this.countVariables(viz.UNIT)){for(var t=new Array,e=this._dataset.columnNames(),s=0;s<e.length;s++)this.countProperties(e[s])>0&&this._dataset.isCategorical(e[s])&&t.push(e[s]);if(this._ds=this._ds.groupBy(t,this.groupby_rules,this.firstVariable(viz.UNIT)),1==this.countVariables(viz.ANIMATION)){var r=this.firstVariable(viz.ANIMATION);null!==this.min_animation&&(this._ds=this._ds.where(function(t){return parseInt(t[r])>=parseInt(i.min_animation)?!0:!1},!1)),null!==this.max_animation&&(this._ds=this._ds.where(function(t){return parseInt(t[r])<=parseInt(i.max_animation)?!0:!1},!1))}if(this.countVariables(viz.DIVISION)>0&&this.countVariables(viz.AREA)>0){t=new Array,t.push(this.firstVariable(viz.UNIT)),this.countVariables(viz.ANIMATION)>0&&t.push(this.firstVariable(viz.ANIMATION));var a=this._ds.groupBy(t,this.groupby_rules);this.max_area_value=a.max(this.firstVariable(viz.AREA)),this.min_area_value=a.min(this.firstVariable(viz.AREA))}}for(var n=0;n<this._ds.header.length;n++){var h=this.orderRule(n);if(null!==h&&0==h.ordered_items.length){for(var o=this._ds.unique(n),v=this._ds.split(n),_={},l=0;l<v.length;l++)_[o[l]]=v[l].sum(h.order_variable);o.sort(function(i,t){return _[i]<_[t]?1:_[i]>_[t]?-1:0}),h.ordered_items=o}}},viz.Properties.fn.applySettingsOrder=function(){if(this.view._settings.order)for(var i in this.view._settings.order)this._dataset.isCategorical(i)&&("string"==typeof this.view._settings.order[i]||this.view._settings.order[i].length)&&this.setOrderRule(i,this.view._settings.order[i])},viz.Properties.fn.applyGrammar=function(){for(var i=this.view._settings.grammar,t=0;t<i.length;t++){var e=i[t];if("string"==typeof e.variable&&"string"==typeof e.property){var s=e.property.toUpperCase();if("undefined"!=typeof viz.PropertyNames[s]){this.link(e.variable,viz.PropertyNames[s]),this.vpedges&&this.vpedges.link(e.variable,viz.PropertyNames[s]);for(var r in e)e.hasOwnProperty(r)&&"variable"!=r&&"property"!=r&&(this.setSettings(e.variable,viz.PropertyNames[s],r,e[r]),this.vpedges&&this.vpedges.setSettings(e.variable,viz.PropertyNames[s],r,e[r]))}}}},viz.PData=function(){this._keys=[],this._values=[],this._settings=[],this._length=0},viz.PData.prototype.add=function(i,t){return this.isSet(i,t)?this:("undefined"==typeof this._keys[i]&&(this._keys[i]=[],this._settings[i]=[]),"undefined"==typeof this._values[t]&&(this._values[t]=[]),this._keys[i].push(t),this._settings[i].push({}),this._values[t].push(i),this)},viz.PData.prototype.remove=function(i,t){if(!this.isSet(i,t))return this;var e=this._keys[i].indexOf(t);-1!=e&&this._keys[i].splice(e,1);var s=this._values[t].indexOf(i);-1!=s&&this._values[t].splice(s,1)},viz.PData.prototype.isSet=function(i,t){return"undefined"!=typeof this._keys[i]&&"undefined"!=typeof this._values[t]&&-1!=this._keys[i].indexOf(t)?!0:!1},viz.PData.prototype.values=function(i){var t=[];return"undefined"!=typeof this._keys[i]&&(t=this._keys[i]),t},viz.PData.prototype.keys=function(i){var t=[];return"undefined"!=typeof this._values[i]&&(t=this._values[i]),t},viz.PData.prototype.settings=function(i,t,e,s){var r=this.values(i).indexOf(t);return"undefined"==typeof e?this._settings[i][r]:"undefined"==typeof s?"undefined"!=typeof this._settings[i][r][e]?this._settings[i][r][e]:!1:(this._settings[i][r][e]=s,this)},viz.PData.prototype.firstValue=function(i){return"undefined"!=typeof this._keys[i]?this._keys[i][0]:null},viz.PData.prototype.firstKey=function(i){return"undefined"!=typeof this._values[i]?this._values[i][0]:null},viz.PData.prototype.secondKey=function(i){return"undefined"!=typeof this._values[i]?this._values[i][1]:null};