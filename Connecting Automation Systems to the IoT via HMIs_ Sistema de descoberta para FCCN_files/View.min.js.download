var viz=viz||{};
viz.View=function(a,b,c,g,d,e){"undefined"!==typeof d?(this._viewgroup=g,this._viewidgroup=d):this._viewidgroup=-1;"string"===typeof c&&(c=JSON.parse(c));this._settings=c||{};this._settings.general=this._settings.general||{};this._settings.grammar=this._settings.grammar||[];this._settings.groupby_rules=this._settings.groupby_rules||{};this._dataset=b;this.unitElements=new GrapeGroup;"string"===typeof a&&(a=by("id:"+a));"svg"!=a.tagName()&&(a.clear(),a=(new Grape("svg")).addTo(a));this._target=a;a=
this.getDimensions();this._width=a.width;this._height=a.height;this._numElements=[];"boolean"===typeof e&&!0!=e||this.init();this._filter_alpha=0.2;this._rangeSliders=[]};viz.View.fn=viz.View.prototype;
viz.View.fn.init=function(a){var b=this;this._rangeSliders=[];this._target.clear().viewbox(0,0,this._width,this._height).width(this._width).height(this._height);var c=(new Grape).beginFill("white",0).rect(0,0,this._width,this._height).addTo(this._target);if(0==this._dataset.length)a=raceme.label("no data",this._width/2,this._height/2,"rgb(100,100,100)",15,"center"),this._target.addChild(a);else{c.clic(function(){return-1!=b._viewidgroup?(b._viewgroup.removeFilters(b._viewidgroup),b._viewgroup.showhideReset(b._viewidgroup),
!1):!0},"background_box",!1);if(a){if(0==a.length)return;this.vp=new viz.Properties(a,this);a.edges&&(this.vpedges=new viz.Properties(a.edges,this),this.vp.vpedges=this.vpedges)}else this.vp=new viz.Properties(this._dataset,this),this._dataset.edges&&(this.vpedges=new viz.Properties(this._dataset.edges,this),this.vp.vpedges=this.vpedges);this.applySettingsOrder();this.vp.groupby_rules=this._settings.groupby_rules;this.applyGrammar();this.vp.init();-1!=this._viewidgroup&&this._viewgroup.eachFilterVar(this._viewidgroup,
function(a){b.vp._dataset.isCategorical(a)&&(b._numElements[a]=b.vp._dataset.unique(a).length)});this._variables_hues&&(this.vp._variables_hues=this._variables_hues);this.frame=new viz.Frame(this.vp,this._width,this._height);this.applySettings();this.frame.init();this.frame._height>this._height&&(this._height=this.frame._height,this._target.viewbox(0,0,this._width,this._height).width(this._width).height(this._height));this.elements=new viz.Elements(this.frame);this.elements.init();this._target.addChild(this.frame.getGrape());
var g=this.elements.getGrape();if((this.frame._map||"graph"==this.frame._frame_type)&&this.frame.zoomable){a=new Grape;var d=raceme._generateId(),e=(new Grape("defs")).addChild((new Grape("clipPath")).id(d).addChild((new Grape("rect")).attr("x",this.frame._dataspace.x).attr("y",this.frame._dataspace.y).attr("width",this.frame._dataspace.width).attr("height",this.frame._dataspace.height)));a.addChild(e);a.style("clip-path","url(#"+d+")");a.addChild(g);d=new Grape;e=(new Grape("filter")).addTo(d);e.shadow(0,
0,2,0.3);d.beginFill("white").lineStyle(1,"white").rect(0,0,30,60).filter(e);d.lineStyle(1,"rgb(230,230,230)").moveTo(3,30).lineTo(27,30);e=new Grape;e.beginFill("#FFFFFF").rect(1,1,28,28).lineStyle(2,"rgb(150,150,150)").line(15,10,15,20).line(10,15,20,15);var h=(new Grape).y(30);h.beginFill("#FFFFFF").rect(1,1,28,28).lineStyle(2,"rgb(150,150,150)").line(10,15,20,15);d.addChild(e).addChild(h);d.x(this.frame._dataspace.x+10).y(this.frame._dataspace.y+10);e.clic(function(){g.zoomIn()});h.clic(function(){g.zoomOut()});
a.addChild(d);this._target.addChild(a)}else this._target.addChild(g);this.frame.legends_grape&&this.frame._floating_legend&&this.frame.legends_grape.addTo(this._target);this.applyTooltip();this.applyResizeResponse();"undefined"==typeof this._variables_hues&&this.vp._variables_hues&&(this._variables_hues=this.vp._variables_hues);this._reset_button&&-1!=this._viewidgroup&&(this.reset_button_grape=(new Grape).x(5).y(this._height-26),a=raceme.label(this._reset_button,8,12,"rgb(60,60,60)",12,"left","top"),
d=a.getBBox(),this.reset_button_grape.beginFill("rgb(200,200,200)",0.5).rect(0,0,d.width+16,21,2),this.reset_button_grape.opacity(0).addChild(a),this._target.addChild(this.reset_button_grape),this.reset_button_grape.clic(function(){c.clic()}),this._viewgroup.showhideReset(this._viewidgroup));this.frame._map&&(this.frame.zoomable&&this.frame.zoom_auto_focus)&&(!this.frame.zoom_auto_focus_box||this.frame.zoom_auto_focus_box.x==this.frame.zoom_auto_focus_box.x2&&this.frame.zoom_auto_focus_box.y==this.frame.zoom_auto_focus_box.y2?
this.frame._map._elms_to_make_zoom=g:g.focusZoom(this.frame.zoom_auto_focus_box));for(a=0;a<this._rangeSliders.length;a++)this.frame.gr.addChild(this._rangeSliders[a])}};viz.View.fn.applySettingsOrder=function(){if(this._settings.order)for(var a in this._settings.order)this._dataset.isCategorical(a)&&("string"==typeof this._settings.order[a]||this._settings.order[a].length)&&this.vp.setOrderRule(a,this._settings.order[a])};
viz.View.fn.applyTooltip=function(){var a=this;if(0<this.vp.countVariables(viz.TOOLTIP)||1<this.vp.countVariables(viz.DIVISION))this.tlp=new racemeTooltip(this._target,this._settings.general),this.frame.tlp=this.tlp,this.frame._player&&this.frame._player.addCallback(function(){a.tlp.update();a.elements.labelsgr._force_redraw&&a.elements.labelsgr._force_redraw()}),this.frame.zoomable&&(this.elements.gr._callwhenchange=function(){a.tlp.update()})};
viz.View.fn.applyResizeResponse=function(){var a=this;window.addEventListener?window.addEventListener("resize",function(){a.resize()},!0):window.attachEvent&&window.attachEvent("onresize",function(){a.resize()})};
viz.View.fn.applyGrammar=function(){for(var a=0;a<this._settings.grammar.length;a++){var b=this._settings.grammar[a];if("string"===typeof b.variable&&"string"===typeof b.property){var c=b.property.toUpperCase();if("undefined"!==typeof viz.PropertyNames[c]){this.vp.link(b.variable,viz.PropertyNames[c]);this.vpedges&&this.vpedges.link(b.variable,viz.PropertyNames[c]);for(var g in b)b.hasOwnProperty(g)&&("variable"!=g&&"property"!=g)&&(this.vp.setSettings(b.variable,viz.PropertyNames[c],g,b[g]),this.vpedges&&
this.vpedges.setSettings(b.variable,viz.PropertyNames[c],g,b[g]))}}}};
viz.View.fn.applySettings=function(){var a=this._settings.general;"string"===typeof a.title&&(this.frame._title=a.title);"string"===typeof a.background_image&&(this.frame._background_image=a.background_image);"number"===typeof a.padding&&(this.frame._padding=a.padding);!1!==raceme._getRGB(a.title_color)&&(this.frame._title_color=a.title_color);"number"===typeof a.title_size&&(this.frame._title_size=a.title_size);"number"==typeof a.default_alpha&&(0<=a.default_alpha&&1>=a.default_alpha)&&(this.vp.default_intensity=
a.default_alpha);"number"==typeof a.default_link_alpha&&(this.vpedges&&0<=a.default_link_alpha&&1>=a.default_link_alpha)&&(this.vpedges.default_intensity=a.default_link_alpha);"number"==typeof a.default_area&&0<a.default_area&&(this.vp.default_area=a.default_area);"number"==typeof a.default_border_width&&(this.vp.default_border_width=a.default_border_width);"number"==typeof a.default_width&&(this.vp.default_width=a.default_width);"string"==typeof a.default_border_color&&(this.vp.default_border_color=
a.default_border_color);!1!==raceme._getRGB(a.default_inner_color)&&(this.vp.default_inner_color=a.default_inner_color);"number"==typeof a.default_inner_alpha&&(0<=a.default_inner_alpha&&1>=a.default_inner_alpha)&&(this.vp.default_inner_alpha=a.default_inner_alpha);"number"==typeof a.default_border_alpha&&(0<=a.default_border_alpha&&1>=a.default_border_alpha)&&(this.vp.default_border_intensity=a.default_border_alpha);"string"==typeof a.default_shape&&"number"===typeof viz.SHAPE_NAMES[a.default_shape]&&
(this.vp.default_form=viz.SHAPE_NAMES[a.default_shape]);"boolean"==typeof a.allow_label_overlapping&&(this.frame._allow_label_overlapping=a.allow_label_overlapping);"string"!=typeof a.label_placement||"in"!=a.label_placement&&"out"!=a.label_placement&&"automatic"!=a.label_placement||(this.frame._label_placement=a.label_placement);"number"==typeof a.donut_padding&&(0<=a.donut_padding&&1>=a.donut_padding)&&(this.vp.default_donut_padding=a.donut_padding);!1!=raceme._getRGB(a.default_color)&&(this.vp.default_hue=
a.default_color);!1!=raceme._getRGB(a.default_link_color)&&this.vpedges&&(this.vpedges.default_hue=a.default_link_color);!1!=raceme._getRGB(a.default_label_color)&&(this.vp.default_label_color=a.default_label_color,this.vpedges&&(this.vpedges.default_label_color=a.default_label_color));"number"==typeof a.default_label_size&&(this.vp.default_label_size=a.default_label_size,this.vpedges&&(this.vpedges.default_label_size=a.default_label_size));"object"==typeof a.colors&&(this.vp.user_selected_colors=
a.colors);"boolean"==typeof a.map_shadow&&(this.frame._map_shadow=a.map_shadow);!1!==raceme._getRGB(a.map_color)&&(this.frame._default_map_color=a.map_color);"number"===typeof a.map_border&&(this.frame._default_map_border=a.map_border);!1!==raceme._getRGB(a.map_border_color)&&(this.frame._default_map_border_color=a.map_border_color);"string"==typeof a.map_projection&&(this.frame._map_projection=a.map_projection);"number"==typeof a.filter_alpha&&(this._filter_alpha=a.filter_alpha);"number"==typeof a.legend_width&&
0<a.legend_width&&(this.frame._legend_width=a.legend_width);"number"==typeof a.bar_width&&(0<a.bar_width&&1>=a.bar_width)&&(this.frame._bar_width=a.bar_width);"string"==typeof a.base_url&&(this.vp.base_url=a.base_url);"string"==typeof a.default_link_target&&(this.vp.default_link_target=a.default_link_target);"string"==typeof a.chart_vertical_align&&(this.frame._chart_vertical_align=a.chart_vertical_align);"string"==typeof a.reset_button&&(this._reset_button=a.reset_button);"boolean"==typeof a.zoom&&
(this.frame.zoomable=a.zoom);"boolean"==typeof a.zoom_auto_focus&&(this.frame.zoom_auto_focus=a.zoom_auto_focus);"boolean"==typeof a.floating_legend&&(this.frame._floating_legend=a.floating_legend);"string"==typeof a.legend_position&&(this.frame._legend_position=a.legend_position)};
viz.View.fn.resize=function(){var a=this;this.resizeTimeout&&clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(function(){var b=a.getDimensions();!1!=isNaN(b.width)||!1!=isNaN(b.height)||b.width==a._width&&b.height==a._height||(a._width=b.width,a._height=b.height,a.init(a.vp._dataset),a.reFade())},250)};
viz.View.fn.getDimensions=function(){var a=new Grape(this._target.seed.parentNode);return{width:parseInt(a.style("width").replace("px","")),height:parseInt(a.style("height").replace("px",""))}};
viz.View.fn.reFade=function(){if(-1!=this._viewidgroup){for(var a=this,b=this._viewgroup.viewsFilters[this._viewidgroup],c=[],g=0;g<this.unitElements.length;g++){for(var d=!0,e=this.unitElements.item(g),h=0;h<b.length&&!1!=d;h++){var k=b[h].variable;if(0<b[h].filtrosAplicados.length)for(var f=0;f<e._viz_filter_classes.length&&!1!=d;f++)if(e._viz_filter_classes[f].variable==k)if("undefined"!==typeof b[h].filtrosAplicados[0].min){if(!e._is_legend_element)if(a._dataset.isDateType(k)){var l,m;if(e._viz_filter_classes[f].value.rule)for(var n=
0;n<e._viz_filter_classes[f].value.rows.length;n++){if(l=a._dataset.columnType(k),m=viz.Utils.date(e._viz_filter_classes[f].value.rows[n],l),m<viz.Utils.date(b[h].filtrosAplicados[0].min,l)||m>viz.Utils.date(b[h].filtrosAplicados[0].max,l)){d=!1;break}}else if(l=a._dataset.columnType(k),m=viz.Utils.date(e._viz_filter_classes[f].value,l),m<viz.Utils.date(b[h].filtrosAplicados[0].min,l)||m>viz.Utils.date(b[h].filtrosAplicados[0].max,l)){d=!1;break}}else if(e._viz_filter_classes[f].value.rule)for(l=
0;l<e._viz_filter_classes[f].value.rows.length;l++){if(e._viz_filter_classes[f].value.rows[l]<b[h].filtrosAplicados[0].min||e._viz_filter_classes[f].value.rows[l]>b[h].filtrosAplicados[0].max){d=!1;break}}else if(e._viz_filter_classes[f].value<b[h].filtrosAplicados[0].min||e._viz_filter_classes[f].value>b[h].filtrosAplicados[0].max){d=!1;break}}else if("string"==typeof e._viz_filter_classes[f].value){if(-1==b[h].filtrosAplicados.indexOf(e._viz_filter_classes[f].value)){d=!1;break}}else if(e._viz_filter_classes[f].value.rule)for("or"==
e._viz_filter_classes[f].value.rule&&(d=!1),l=0;l<e._viz_filter_classes[f].value.rows.length;l++)if("or"==e._viz_filter_classes[f].value.rule&&-1!=b[h].filtrosAplicados.indexOf(e._viz_filter_classes[f].value.rows[l])){d=!0;break}else if("and"==e._viz_filter_classes[f].value.rule&&-1==b[h].filtrosAplicados.indexOf(e._viz_filter_classes[f].value.rows[l])){d=!1;break}}c[g]=d?1:e._is_legend_element?0.3:e._is_graph_link?0:this._filter_alpha}this.unitElements.show();this.unitElements.stop().animate(100).opacity(c).done(function(){if(0==
a._filter_alpha)for(var b=0;b<a.unitElements.length;b++)0==c[b]&&a.unitElements.item(b).hide()});-1!=this._viewidgroup&&this.reset_button_grape&&this._viewgroup.showhideReset(this._viewidgroup)}};viz.View.fn.reInit=function(a){var b=this;setTimeout(function(){b.init(a);b.reFade()},120)};
viz.View.fn.filterWrapper=function(a,b,c){var g=this,d=!1;if(this._dataset.isCategorical(b)&&(!this._dataset.isDateType(b)||this.vp.firstVariable(viz.POS_X)!=b&&this.vp.firstVariable(viz.POS_Y)!=b||(d=!0),this.eachFilterVar(function(e){var k;if(c._indices)k={rule:"or",rows:c.unique(e)},1==k.rows.length&&(k=k.rows[0]);else if("string"!==typeof c&&c.length)if("string"!==typeof c[0]&&c[0].length){k={rule:"and",rows:[]};for(var f=0;f<c.length;f++)k.rows.push(c[f][e])}else k=c[e];else"string"===typeof c&&
(k=c);a._viz_filter_classes=a._viz_filter_classes||[];a._viz_otrasCondiciones=a._viz_otrasCondiciones||[];null!==b&&e==b?(a._viz_filter_classes.push({variable:e,value:k}),a._viz_filter_interactions={variable:e,value:k},a.enableEvents(!0),g._numElements[b]&&(1<g._numElements[b]&&!1==d)&&a.fixedclic(function(){g.clicFilter(this._viz_filter_interactions,this._viz_otrasCondiciones)})):k!=c&&a._viz_filter_classes.push({variable:e,value:k})}),a._viz_filter_classes&&0<a._viz_filter_classes.length&&(this.unitElements.push(a),
a._viz_filter_interactions&&g.vp.isSet(a._viz_filter_interactions.variable,viz.DIVISION))))for(var e=0;e<a._viz_filter_classes.length;e++)a._viz_filter_classes[e].variable!=a._viz_filter_interactions.variable&&g.vp.isSet(a._viz_filter_classes[e].variable,viz.DIVISION)&&a._viz_otrasCondiciones.push(a._viz_filter_classes[e])};
viz.View.fn.filterWrapperAxis=function(a){var b=a._variable;if(!1==this._dataset.isCategorical(b)||this._dataset.isDateType(b)){var c=this;this.eachFilterVar(function(g){if(g==b){var d=0,e=a._max_posicion-a._min_posicion;c._dataset.isCategorical(b)&&(d=e/a._ticks);var e=e-d,h=a._orientation,k=a._reversed,f=a._scale,l=0,m=0;0<d&&("horizontal"==a._orientation&&(l=d/2),"vertical"==a._orientation&&(m=d/2));var d=c._dataset.isCategorical(b)?a._ticks_values:{min:a._min,max:a._max},n,r;if(this.viewsFilters&&
this.viewsFilters[c._viewidgroup])for(var p=0;p<this.viewsFilters[c._viewidgroup].length;p++)if(this.viewsFilters[c._viewidgroup][p].variable==b){var q=this.viewsFilters[c._viewidgroup][p].filtrosAplicados;q.length&&(n=q[0].min,r=q[0].max)}c._rangeSliders.push((new viz.RangeSlider(e,h,k,d,function(a,b){c.clicFilter({variable:g,min:a,max:b})},f,n,r)).getGrape().x(a.innerX()+l).y(a.innerY()+m))}})}};
viz.View.fn.eachFilterVar=function(a){-1!=this._viewidgroup&&this._viewgroup.eachFilterVar(this._viewidgroup,a)};viz.View.fn.clicFilter=function(a,b){-1!=this._viewidgroup&&this._viewgroup.clicFilter(this._viewidgroup,a,b)};viz.ViewGroup=function(a){this._dataset=a;this.views=[];this.viewsFilters=[];this.viewidcounter=0};viz.ViewGroup.fn=viz.ViewGroup.prototype;
viz.ViewGroup.fn.add=function(a,b){var c=new viz.View(a,this._dataset,b,this,this.viewidcounter,!1);this.views.push(c);if("undefined"!==typeof c._settings.filters&&c._settings.filters.length){for(var g=[],d=0;d<c._settings.filters.length;d++){var e=this._dataset.header.getId(c._settings.filters[d].variable);g.push({variable:e,seleccion:c._settings.filters[d].selection,filtrosAplicados:[]})}this.viewsFilters.push(g)}else this.viewsFilters.push([]);this.viewidcounter++;c.init();return this};
viz.ViewGroup.fn.eachFilterVar=function(a,b){for(var c=0;c<this.viewsFilters[a].length;c++)b.call(this,this.viewsFilters[a][c].variable)};viz.ViewGroup.fn.removeFilters=function(a){for(var b=!1,c=this.viewsFilters[a],g=0;g<c.length;g++)0<c[g].filtrosAplicados.length&&(c[g].filtrosAplicados=[],b=!0);b&&this.reGen(a);if(this.views[a]._rangeSliders)for(g=0;g<this.views[a]._rangeSliders.length;g++)this.views[a]._rangeSliders[g]._reset_slider()};
viz.ViewGroup.fn.showhideReset=function(a){if(this.views[a].reset_button_grape){for(var b=!0,c=this.viewsFilters[a],g=0;g<c.length;g++)if(0<c[g].filtrosAplicados.length){b=!1;break}b?0<this.views[a].reset_button_grape.opacity()&&this.views[a].reset_button_grape.stop().animate(100).opacity(0).done(function(){this.hide()}):0==this.views[a].reset_button_grape.opacity()&&this.views[a].reset_button_grape.opacity(0).show().stop().animate(100).opacity(1)}};
viz.ViewGroup.fn.clicFilter=function(a,b,c){var g=!1;c=c||[];for(var d=this.viewsFilters[a],e=!1,h=!1,k=0,f=0;f<d.length;f++)if(d[f].variable==b.variable){k=f;if("undefined"!==typeof b.min)d[f].filtrosAplicados=[{min:b.min,max:b.max}],g=!0;else if(0==d[f].filtrosAplicados.length||"simple"==d[f].seleccion&&1<d[f].filtrosAplicados.length)d[f].filtrosAplicados=[b.value],e=!0;else{var l=d[f].filtrosAplicados.indexOf(b.value);-1!=l?d[f].filtrosAplicados.splice(l,1):("simple"==d[f].seleccion?d[f].filtrosAplicados=
[b.value]:(d[f].filtrosAplicados.push(b.value),d[f].filtrosAplicados.length==this.views[a]._numElements[b.variable]&&(h=!0,filtro_primario_limpiar=f)),e=!0)}break}if(c.length)for(f=0;f<d.length;f++)if(f!=k)for(b=0;b<c.length;b++)if(d[f].variable==c[b].variable)if(!0==e){if("simple"==d[f].seleccion||0==d[f].filtrosAplicados.length)"string"==typeof c[b].value?d[f].filtrosAplicados=[c[b].value]:c[b].value.rows.length&&(d[f].filtrosAplicados=c[b].value.rows.slice(0));else if("string"==typeof c[b].value)-1==
d[f].filtrosAplicados.indexOf(c[b].value)&&d[f].filtrosAplicados.push(c[b].value);else if(typeof c[b].value.rows.length)for(l=0;l<c[b].value.rows.length;l++)-1==d[f].filtrosAplicados.indexOf(c[b].value.rows[l])&&d[f].filtrosAplicados.push(c[b].value.rows[l]);h&&d[f].filtrosAplicados.length==this.views[a]._numElements[c[b].variable]&&(d[f].filtrosAplicados=[],d[filtro_primario_limpiar].filtrosAplicados=[])}else if("simple"==d[f].seleccion)d[f].filtrosAplicados=[];else if(c[b].value.rule)for(l=0;l<
c[b].value.rows.length;l++){var m=d[f].filtrosAplicados.indexOf(c[b].value.rows[l]);-1!=m&&d[f].filtrosAplicados.splice(m,1)}this.reGen(a,g)};
viz.ViewGroup.fn.reGen=function(a,b){for(var c=this,g=[],d=0;d<this.viewsFilters.length;d++)for(var e=0;e<this.viewsFilters[d].length;e++)0<this.viewsFilters[d][e].filtrosAplicados.length&&g.push({variable:this.viewsFilters[d][e].variable,filtrosAplicados:this.viewsFilters[d][e].filtrosAplicados,id_view:d});var h;this.views[a].reFade();var k;if(b)this.rangeTimer&&(clearTimeout(this.rangeTimer),this.rangeTimer=null),c=this,this.rangeTimer=setTimeout(function(){for(k=0;k<c.views.length;k++)k!=a&&(h=
c.remakeDataSet(k,g),c.views[k].reInit(h))},300);else for(k=0;k<c.views.length;k++)k!=a&&(h=this.remakeDataSet(k,g),c.views[k].reInit(h))};
viz.ViewGroup.fn.remakeDataSet=function(a,b){var c,g=this;0<b.length?(c=this._dataset.where(function(c){for(var e=0;e<b.length;e++)if(b[e].id_view!=a){var h=b[e].variable;if("undefined"!==typeof b[e].filtrosAplicados[0]&&"undefined"!==typeof b[e].filtrosAplicados[0].min)if(g._dataset.isDateType(h)){var k=g._dataset.columnType(h),h=viz.Utils.date(c[h],k);if(h<viz.Utils.date(b[e].filtrosAplicados[0].min,k)||h>viz.Utils.date(b[e].filtrosAplicados[0].max,k))return!1}else{if(c[h]<b[e].filtrosAplicados[0].min||
c[h]>b[e].filtrosAplicados[0].max)return!1}else if(-1==b[e].filtrosAplicados.indexOf(c[h]))return!1}return!0},!1),this._dataset.edges&&(c.edges=this._dataset.edges.clone(),c.edges.initAsNetwork(c))):c=this._dataset;return c};
