var viz=viz||{};viz.Utils={},viz.Utils.log10=function(t){return Math.LOG10E*Math.log(Math.max(t,1e-6))},viz.Utils.log2=function(t){return Math.LOG2E*Math.log(Math.max(t,.125))},viz.Utils.round=function(t,i){if("undefined"==typeof t)return 0;if("undefined"==typeof i||0==i)return Math.round(t);var e=Math.pow(10,i);return Math.round(t*e)/e},viz.Utils.fmod=function(t,i){return Number((t-Math.floor(t/i)*i).toPrecision(8))},viz.Utils.map=function(t,i,e,r,n){if(i==e||r==n)return r;var a=!1,s=Math.min(i,e),h=Math.max(i,e);s!=i&&(a=!0);var g=!1,o=Math.min(r,n),u=Math.max(r,n);o!=r&&(g=!0);var d=(t-s)*(u-o)/(h-s);a&&(d=(h-t)*(u-o)/(h-s));var m=d+o;return g&&(m=u-d),m},viz.Utils.mapLin2Log=function(t,i,e,r,n){var a=i,s=e,h=Math.log(r),g=Math.log(n),o=(g-h)/(s-a);return Math.exp(h+o*(t-a))},viz.Utils.decimals=function(t){var i=(""+t).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);return i?Math.max(0,(i[1]?i[1].length:0)-(i[2]?+i[2]:0)):0},viz.Utils.cosArctan=function(t,i){var e=t/i;return i>0?1/Math.sqrt(1+e*e):-1/Math.sqrt(1+e*e)},viz.Utils.sinArctan=function(t,i){var e=t/i;return i>0?e/Math.sqrt(1+e*e):-e/Math.sqrt(1+e*e)},viz.Utils.intersectRect=function(t,i){return!(i.x>t.x+t.width||i.x+i.width<t.x||i.y>t.y+t.height||i.y+i.height<t.y)},viz.Utils.intersectRectCircle=function(t,i){var e=Math.abs(i.x-t.x-t.width/2),r=Math.abs(i.y-t.y-t.height/2);if(e>t.width/2+i.radius)return!1;if(r>t.height/2+i.radius)return!1;if(e<=t.width/2)return!0;if(r<=t.height/2)return!0;var n=e-t.width/2,a=r-t.height/2;return n*n+a*a<=i.radius*i.radius},viz.Utils.objInterpolation=function(t,i){for(var e=-1,r=-1,n=0;n<t.length;n++)if("undefined"==typeof t[n]){if(e>-1){if(n>=r)for(u=n+1;u<t.length;u++)if("undefined"!=typeof t[u]){r=u;break}if(r>n){t[n]={};for(var a=0;a<i.length;a++){var s=i[a];t[n][s]=raceme.map(n,e,r,t[e][s],t[r][s])}}}}else e=n;return t},viz.Utils.isValidDate=function(t){return"[object Date]"!==Object.prototype.toString.call(t)?!1:!isNaN(t.getTime())},viz.Utils.date=function(t,i){var e=new Date;if("dd"==i)e.setFullYear(1970),e.setMonth(0),e.setUTCDate(t.substr(0,2));else if("YYYY"==i)e.setFullYear(parseInt(t.substr(0,4)));else{var r=i.indexOf("YYYY"),n=i.indexOf("MM"),a=i.indexOf("dd");if(-1==r&&-1==n&&-1==a)return!1;r>-1&&e.setFullYear(parseInt(t.substr(r,4))),n>-1&&e.setMonth(parseInt(t.substr(n,2))-1),a>-1&&e.setUTCDate(parseInt(t.substr(a,2)))}return 0==viz.Utils.isValidDate(e)?!1:(e._viz_utils_format=i,e.setHours(1,0,0,0),e)},Date.prototype.strformat=function(t,i){return"undefined"==typeof t&&this._viz_utils_format&&(t=this._viz_utils_format),"YYYY"==t?viz.Utils.pad(this.getFullYear().toString(),4):"MM"==t?i&&i.month&&this.toLocaleString?this.toLocaleString(window.navigator.language,i):viz.Utils.pad((this.getMonth()+1).toString(),2):"dd"==t?viz.Utils.pad(this.getUTCDate().toString(),2):"MM-YYYY"==t?this.strformat("MM",i)+"-"+this.strformat("YYYY"):"YYYY-MM"==t?this.strformat("YYYY")+"-"+this.strformat("MM",i):"dd-MM"==t?this.strformat("dd")+"-"+this.strformat("MM",i):"dd-MM-YYYY"==t?this.strformat("dd")+"-"+this.strformat("MM",i)+"-"+this.strformat("YYYY"):"YYYY-MM-dd"==t?this.strformat("YYYY")+"-"+this.strformat("MM",i)+"-"+this.strformat("dd"):"MM-dd-YYYYY"==t?this.strformat("MM",i)+"-"+this.strformat("dd")+"-"+this.strformat("YYYY"):this.strformat("dd-MM-YYYY",i)},viz.Utils.pad=function(t,i){for(var e=t+"";e.length<i;)e="0"+e;return e},viz.Utils.differenceInDays=function(t,i){var e=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()),r=Date.UTC(i.getFullYear(),i.getMonth(),i.getDate());return Math.floor((r-e)/864e5)},viz.Utils.differenceInMonths=function(t,i){var e;return e=12*(i.getFullYear()-t.getFullYear()),e-=t.getMonth()+1,e+=i.getMonth(),i.getDate()>=t.getDate()&&e++,0>=e?0:e},viz.Utils.squareWidthIntoRectangle=function(t,i,e){var r,n,a=Math.ceil(Math.sqrt(e*t/i));r=Math.floor(a*i/t)*a<e?i/Math.ceil(a*i/t):t/a;var s=Math.ceil(Math.sqrt(e*i/t));return n=Math.floor(s*t/i)*s<e?t/Math.ceil(t*s/i):i/s,Math.max(r,n)},viz.Utils.generateId=function(){return raceme._generateId()},viz.Utils.labelPlacement=function(t,i,e){var r=i*e,n=2*Math.sqrt(r/t.length);if(t.length>0)for(var a=0;a<t.length;a++){var s=0,h=0;t[a].x=t[a].circle_x,t[a].y=t[a].circle_y+t[a].circle_r;for(var g=t[a].x,o=t[a].y,u=0;u<t.length;u++){var d=t[u].circle_x,m=t[u].circle_y,c=g-d,l=o-m,_=raceme.distance({x:g,y:o},{x:d,y:m});if(_>t[u].circle_r&&u!=a&&(_-=t[u].circle_r),_>0&&n/4>_&&(s+=c/_*(n/_),h+=l/_*(n/_)),u!=a){d=t[u].x,m=t[u].y;var c=g-d,l=o-m,_=raceme.distance({x:g,y:o},{x:d,y:m});_>0&&n/4>_&&(s+=c/_*(n/_),h+=l/_*(n/_))}}n>i-g&&(s-=Math.abs(g-i)*n),n>g&&(s+=Math.abs(g)*n),n>e-o&&(h-=Math.abs(o-e)*n),n>o&&(h+=Math.abs(o)*n),t[a].x+=s,t[a].y+=h;var p=raceme.rect2polar(t[a].x-t[a].circle_x,t[a].y-t[a].circle_y).angle,f=raceme.polar2rect(t[a].circle_r,p);t[a].angle=p,t[a].x=t[a].circle_x+f.x,t[a].y=t[a].circle_y+f.y}return t},viz.RangeSlider=function(t,i,e,r,n,a,s,h){var g=this;this.width=t,this.reversed=e,"undefined"==typeof a?this.scale="lin":("log2"!=a&&"log10"!=a&&(a="lin"),this.scale=a),this.orientation=i,this.range=r,"undefined"!=typeof r.min?this.rangeType="continuous":this.rangeType="discrete","discrete"==this.rangeType&&(this.range.min=r[0],this.range.max=r[r.length-1]),this.update_fn=n,"undefined"==typeof s?this.current_min=r.min:(this.current_min=s,"continuous"==this.rangeType?this.current_min=Math.max(this.current_min,r.min):-1==r.indexOf(this.current_min)&&(this.current_min=r.min)),"undefined"==typeof h?this.current_max=r.max:(this.current_max=h,"continuous"==this.rangeType?this.current_max=Math.min(this.current_max,r.max):-1==r.indexOf(this.current_max)&&(this.current_max=r.max)),this.start_grape=new Grape,this.end_grape=new Grape,this.range_grape=new Grape,this.gr=new Grape,this.range.max!=this.range.min&&(this.gr._reset_slider=function(){g.reset()},this.start_grape.beginFill("rgb(0, 179, 114)",.1).circle(0,0,17).beginFill("rgb(0, 179, 114)").circle(0,0,4),this.end_grape.beginFill("rgb(0, 179, 114)",.1).circle(0,0,17).beginFill("rgb(0, 179, 114)").circle(0,0,4),this.range_grape.addTo(this.gr),this.start_grape.addTo(this.gr),this.end_grape.addTo(this.gr),this.updateMinMax(),this.updateRangeGrape(),this.current_min==this.current_max&&("vertical"==this.orientation?(this.current_min==this.range.min&&this.start_grape.toFront(),this.current_max==this.range.max&&this.end_grape.toFront()):(this.current_min==this.range.min&&this.end_grape.toFront(),this.current_max==this.range.max&&this.start_grape.toFront())),this.end_grape.drag(function(t){"vertical"==g.orientation?g._diff_mouse=g.getMousePosition(t).y-(this.y()+g.gr.y()):g._diff_mouse=g.getMousePosition(t).x-(this.x()+g.gr.x())},function(t){var i;if(i="vertical"==g.orientation?g.getMousePosition(t).y-g.gr.y()-g._diff_mouse:g.getMousePosition(t).x-g.gr.x()-g._diff_mouse,"discrete"==g.rangeType){var e=g.width/(g.range.length-1);i=parseInt((i+e/2)/e)*e}"horizontal"==g.orientation?(i=Math.max(i,g.start_grape.x()),i=Math.min(i,g.width),this.x(i)):(i=Math.max(i,0),i=Math.min(i,g.start_grape.y()),this.y(i)),g.updateRangeGrape(),g.updateCall()},function(t){this.toFront()}),this.start_grape.drag(function(t){"vertical"==g.orientation?g._diff_mouse=g.getMousePosition(t).y-(this.y()+g.gr.y()):g._diff_mouse=g.getMousePosition(t).x-(this.x()+g.gr.x())},function(t){var i;if(i="vertical"==g.orientation?g.getMousePosition(t).y-g.gr.y()-g._diff_mouse:g.getMousePosition(t).x-g.gr.x()-g._diff_mouse,"discrete"==g.rangeType){var e=g.width/(g.range.length-1);i=parseInt((i+e/2)/e)*e}"horizontal"==g.orientation?(i=Math.max(i,0),i=Math.min(i,g.end_grape.x()),this.x(i)):(i=Math.min(i,g.width),i=Math.max(i,g.end_grape.y()),this.y(i)),g.updateRangeGrape(),g.updateCall()},function(t){this.toFront()}),this.range_grape.drag(function(t){"vertical"==g.orientation?g._diff_mouse=g.getMousePosition(t).y-(this.y()+g.gr.y()):g._diff_mouse=g.getMousePosition(t).x-(this.x()+g.gr.x())},function(t){var i;if(i="vertical"==g.orientation?g.getMousePosition(t).y-g.gr.y()-g._diff_mouse:g.getMousePosition(t).x-g.gr.x()-g._diff_mouse,"discrete"==g.rangeType){var e=g.width/(g.range.length-1);i=parseInt((i+e/2)/e)*e}"horizontal"==g.orientation?(i=Math.max(i,0),i=Math.min(i,g.width-(g.end_grape.x()-g.start_grape.x())),g.end_grape.x(i+(g.end_grape.x()-g.start_grape.x())),g.start_grape.x(i),g.updateRangeGrape(),g.updateCall()):(i=Math.max(i,0),i=Math.min(i,g.width-(g.start_grape.y()-g.end_grape.y())),g.start_grape.y(i+(g.start_grape.y()-g.end_grape.y())),g.end_grape.y(i),g.updateRangeGrape(),g.updateCall())},function(t){}))},viz.RangeSlider.fn=viz.RangeSlider.prototype,viz.RangeSlider.fn.reset=function(){"continuous"==this.rangeType?this.current_min=this.range.min:this.current_min=this.range[0],"continuous"==this.rangeType?this.current_max=this.range.max:this.current_max=this.range[this.range.length-1],this.updateMinMax(),this.updateRangeGrape()},viz.RangeSlider.fn.getGrape=function(){return this.gr},viz.RangeSlider.fn.updateRangeGrape=function(){"horizontal"==this.orientation?this.range_grape.clear().x(this.start_grape.x()).beginFill("rgb(0, 179, 114)",0).rect(0,-8,this.end_grape.x()-this.start_grape.x(),16).beginFill("rgb(0, 179, 114)").rect(0,-2,this.end_grape.x()-this.start_grape.x(),4):this.range_grape.clear().y(this.end_grape.y()).beginFill("rgb(0, 179, 114)",0).rect(-8,0,16,this.start_grape.y()-this.end_grape.y()).beginFill("rgb(0, 179, 114)").rect(-2,0,4,this.start_grape.y()-this.end_grape.y())},viz.RangeSlider.fn.updateCall=function(){var t=this.current_min,i=this.current_max,e=viz.Utils.map;if("continuous"==this.rangeType)"horizontal"==this.orientation?"lin"==this.scale?this.reversed?(this.current_min=e(this.end_grape.x(),this.width,0,this.range.min,this.range.max),this.current_max=e(this.start_grape.x(),this.width,0,this.range.min,this.range.max)):(this.current_min=e(this.start_grape.x(),0,this.width,this.range.min,this.range.max),this.current_max=e(this.end_grape.x(),0,this.width,this.range.min,this.range.max)):("log2"==this.scale||"log10"==this.scale)&&(this.reversed?(this.current_min=viz.Utils.mapLin2Log(this.end_grape.x(),this.width,0,this.range.min,this.range.max),this.current_max=viz.Utils.mapLin2Log(this.start_grape.x(),this.width,0,this.range.min,this.range.max)):(this.current_min=viz.Utils.mapLin2Log(this.start_grape.x(),0,this.width,this.range.min,this.range.max),this.current_max=viz.Utils.mapLin2Log(this.end_grape.x(),0,this.width,this.range.min,this.range.max))):"lin"==this.scale?this.reversed?(this.current_min=e(this.end_grape.y(),0,this.width,this.range.min,this.range.max),this.current_max=e(this.start_grape.y(),0,this.width,this.range.min,this.range.max)):(this.current_min=e(this.start_grape.y(),this.width,0,this.range.min,this.range.max),this.current_max=e(this.end_grape.y(),this.width,0,this.range.min,this.range.max)):("log2"==this.scale||"log10"==this.scale)&&(this.reversed?(this.current_min=viz.Utils.mapLin2Log(this.width-this.end_grape.y(),this.width,0,this.range.min,this.range.max),this.current_max=viz.Utils.mapLin2Log(this.width-this.start_grape.y(),this.width,0,this.range.min,this.range.max)):(this.current_min=viz.Utils.mapLin2Log(this.width-this.start_grape.y(),0,this.width,this.range.min,this.range.max),this.current_max=viz.Utils.mapLin2Log(this.width-this.end_grape.y(),0,this.width,this.range.min,this.range.max)));else{var r,n,a=this.width/(this.range.length-1);"horizontal"==this.orientation?(r=Math.round(this.start_grape.x()/a),n=Math.round(this.end_grape.x()/a),this.reversed?(this.current_min=this.range[this.range.length-1-n],this.current_max=this.range[this.range.length-1-r]):(this.current_min=this.range[r],this.current_max=this.range[n])):(r=Math.round(this.end_grape.y()/a),n=Math.round(this.start_grape.y()/a),this.reversed?(this.current_min=this.range[this.range.length-1-n],this.current_max=this.range[this.range.length-1-r]):(this.current_min=this.range[r],this.current_max=this.range[n]))}(t!=this.current_min||i!=this.current_max)&&this.update_fn.call(this,this.current_min,this.current_max)},viz.RangeSlider.fn.updateMinMax=function(){if("continuous"==this.rangeType)"horizontal"==this.orientation?(this.start_grape.x(raceme.map(this.current_min,this.range.min,this.range.max,0,this.width)),this.end_grape.x(raceme.map(this.current_max,this.range.min,this.range.max,0,this.width))):(this.start_grape.y(raceme.map(this.current_min,this.range.min,this.range.max,this.width,0)),this.end_grape.y(raceme.map(this.current_max,this.range.min,this.range.max,this.width,0)));else{var t=this.range.indexOf(this.current_min);-1==t&&(t=0);var i=this.range.indexOf(this.current_max);-1==i&&(i=0),t>i&&(i=t);var e=this.width/(this.range.length-1);"horizontal"==this.orientation?(this.start_grape.x(t*e),this.end_grape.x(i*e)):(this.start_grape.y(i*e),this.end_grape.y(t*e))}},viz.RangeSlider.fn.getMousePosition=function(t){var i=this.gr.seed.ownerSVGElement.createSVGPoint();return i.x=t.clientX,i.y=t.clientY,i=i.matrixTransform(this.gr.seed.ownerSVGElement.getScreenCTM().inverse())};